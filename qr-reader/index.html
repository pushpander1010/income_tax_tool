<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Ads (only if available; injected later to avoid layout shift) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6216304334889617" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
  <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">

  <!-- CDN hints -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR Reader - Scan QR Codes Online (Camera & Image) | UpTools</title>

  <!-- SEO -->
  <meta name="description" content="Free QR code scanner in your browser. Tap Enable Camera to trigger the permission prompt, then scan via camera or upload an image. Multiple codes, Wi-Fi & vCard parsing, copy/share/open, torch, camera switch, local history. Privacy-first - no uploads." />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:large" />
  <link rel="canonical" href="https://www.uptools.in/qr-reader/" />
  <meta name="theme-color" content="#0b1020" />

  <!-- Favicons -->
  <link rel="icon" sizes="48x48" type="image/svg+xml" href="/assets/logo/uptools-logo.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/uptools-logo.svg">

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="QR Reader - Scan QR Codes Online" />
  <meta property="og:description" content="Enable camera permission with one tap and scan QR codes instantly. Works on-device - no uploads." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.uptools.in/qr-reader/" />
  <meta property="og:image" content="/assets/og/qr-reader.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="QR Reader - Scan QR Codes Online" />
  <meta name="twitter:description" content="Grant camera permission and scan QR codes. Copy/share/open results, Wi-Fi/vCard parsing, history, torch & camera switch." />
  <meta name="twitter:image" content="/assets/og/qr-reader.png" />

  <!-- Common CSS (shared) -->
  <link rel="preload" href="/style.css?v=1.2.4" as="style">
  <link rel="stylesheet" href="/style.css?v=1.2.4" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="/style.css?v=1.2.4"></noscript>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebApplication","name":"QR Reader","url":"https://www.uptools.in/qr-reader/","applicationCategory":"Utility","operatingSystem":"Web","isAccessibleForFree":true,"creator":{"@type":"Organization","name":"UpTools"},"featureList":["Enable Camera permission prompt","Live camera scanning","Image upload scanning","Multiple QR detection","Wi-Fi & vCard parsing","Copy/Share/Open actions","Torch toggle","Front/Back camera switch","Local history + export"]}
  </script>
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[
    {"@type":"Question","name":"How do I get the camera permission prompt?","acceptedAnswer":{"@type":"Answer","text":"Tap Enable Camera or the video area. We request getUserMedia() directly from your tap, which shows the browser's permission prompt. Use HTTPS or localhost."}},
    {"@type":"Question","name":"Does this upload my video or images?","acceptedAnswer":{"@type":"Answer","text":"No. All scanning happens locally in your browser. Nothing is uploaded."}},
    {"@type":"Question","name":"Can I scan from a photo or screenshot?","acceptedAnswer":{"@type":"Answer","text":"Yes. Use Upload Image or drag & drop an image onto the video area."}}
  ]}
  </script>

  <style>
    /* Page-scoped helpers (qr-*) layered on top of /style.css */
    .qr-wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    .qr-main{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;padding:16px;align-items:stretch;min-height:calc(100dvh - 56px - 64px)}
    .qr-panel{background:color-mix(in oklab,var(--card,#121a2c) 95%,transparent);border:1px solid var(--border,#223);border-radius:14px;padding:12px;box-shadow:var(--shadow,0 8px 30px rgba(0,0,0,.35))}
    .qr-media{display:grid;grid-template-rows:auto auto auto 1fr auto;gap:10px}

    /* Permission/info strip (stable height) */
    .perm-strip{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px dashed var(--border);background:#0b1326;border-radius:12px;padding:10px}
    .perm-strip .note{margin:0}

    /* Viewport (no overflow) */
    .qr-video-wrap{position:relative;width:100%;aspect-ratio:16/10;max-height:min(52vh,520px);border-radius:12px;overflow:hidden;background:#000;margin:2px 0;contain:content}
    .qr-video,.qr-overlay{position:absolute;inset:0;width:100%;height:100%;display:block}
    .qr-video{object-fit:contain;background:#000}
    .qr-overlay{pointer-events:none}

    /* Tap-to-enable layer (visible before permission) */
    .qr-tap{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.35);backdrop-filter:blur(1px);font-weight:800}
    .qr-tap.hide{display:none}

    .qr-controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    .qr-actions{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .qr-selects{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .qr-side{display:grid;grid-template-rows:auto auto 1fr auto;gap:12px}
    .qr-results{display:grid;gap:8px;overflow:auto}
    .qr-result{padding:10px;border-radius:10px;border:1px solid var(--border,#223);background:rgba(25,30,45,.55);display:grid;gap:6px}
    .qr-badges{display:flex;flex-wrap:wrap;gap:6px}
    .qr-badge{font:700 12px/1.8 system-ui;padding:2px 8px;border-radius:999px;border:1px solid #1a2b3a;background:#0e1724}

    .qr-youtube{border-radius:12px;overflow:hidden;background:#000}
    .qr-youtube iframe{display:block;width:100%;aspect-ratio:16/9}

    @media (max-width:980px){
      .qr-main{grid-template-columns:1fr}
      .qr-controls{grid-template-columns:repeat(2,minmax(0,1fr))}
      .qr-actions{grid-template-columns:repeat(2,minmax(0,1fr))}
      .qr-video-wrap{max-height:min(45vh,420px)}
    }
  </style>
</head>
<body>
  <div class="qr-wrap">
    <!-- Header -->
    <header class="site" role="banner">
      <div class="header-inner">
        <a class="brand" href="/" aria-label="UpTools Home">
          <img src="/assets/logo/uptools-logo.svg" alt="UpTools logo" width="28" height="28" loading="eager">
          <b>UpTools</b>
        </a>
        <nav class="nav-links" aria-label="Primary">
          <a href="/#tools">Tools</a>
          <a href="/income-tax-tool/">Income Tax</a>
          <a href="/emi-calculator/">EMI</a>
          <a aria-current="page" href="/qr-reader/">QR Reader</a>
          <a href="/gst-calculator/">GST</a>
        </nav>
      </div>
    </header>

    <main class="qr-main container" id="main" aria-labelledby="page-title">
      <!-- Camera + Controls -->
      <section class="qr-panel qr-media" aria-label="QR camera scanner">
        <div class="perm-strip" id="permStrip" role="status" aria-live="polite">
          <p class="note" id="permText">Tap <b>Enable Camera</b> (or the video area). We'll auto-start scanning and stop after the first code.</p>
          <div style="display:flex;gap:8px">
            <button id="btnEnable" class="btn">Enable Camera</button>
            <button id="btnHelp" class="btn secondary" title="If you don't see a prompt">Help</button>
          </div>
        </div>

        <div class="qr-mini" style="display:flex;align-items:center;gap:8px">
          <span class="text-logo" aria-hidden="true" style="font-weight:800;padding:2px 8px;border-radius:8px;border:1px solid #2a3b5a;background:#0e1a2b">QR</span>
          <div>
            <h1 id="page-title" style="margin:0;">QR Reader</h1>
            <p class="note" style="margin:2px 0 0;">Privacy-first. On-device. No uploads.</p>
          </div>
        </div>

        <div class="qr-controls">
          <!-- Removed Start: auto-scan triggers on permission -->
          <button class="btn" id="btnAgain" title="Scan again" disabled>Scan Again</button>
          <button class="btn" id="btnStop" disabled>Stop</button>
          <button class="btn" id="btnTorch" disabled title="Toggle flashlight">ðŸ”¦ Torch</button>
          <button class="btn" id="btnSwitch" title="Switch camera">Switch</button>
        </div>

        <div class="qr-actions">
          <label class="btn" for="fileInput" title="Upload image to scan">Upload Image</label>
          <input id="fileInput" type="file" accept="image/*" hidden>
          <button class="btn" id="btnSnap" title="Scan current frame">Snap</button>
          <a class="btn secondary" href="#help">Help</a>
        </div>

        <div class="qr-selects">
          <select id="cameraSel" class="input" aria-label="Camera"></select>
          <select id="resSel" class="input" aria-label="Resolution">
            <option value="default">Auto Resolution</option>
            <option value="hd">HD (1280Ã—720)</option>
            <option value="fhd">Full HD (1920Ã—1080)</option>
            <option value="uhd">UHD (2560Ã—1440)</option>
          </select>
        </div>

        <div class="qr-video-wrap" id="videoWrap" aria-live="off">
          <video id="qrVideo" class="qr-video" autoplay playsinline muted></video>
          <canvas id="qrOverlay" class="qr-overlay" aria-hidden="true"></canvas>
          <button id="tapToEnable" class="qr-tap btn secondary" type="button" aria-label="Tap to enable camera">
            Tap to Enable Camera
          </button>
        </div>

        <div class="qr-actions">
          <button class="btn" id="btnScanScreen" title="Capture a window/tab and scan its QR (desktop)">Scan Screen</button>
          <a class="btn" href="/qr-generator/"><span class="text-logo" aria-hidden="true">QR</span> Create QR</a>
          <a class="btn secondary" href="/sitemap.xml">Sitemap</a>
        </div>
      </section>

      <!-- Results + Help + Video + Ad -->
      <section class="qr-panel qr-side" aria-label="Results and help">
        <div>
          <h2 style="margin:0 0 6px;">Results</h2>
          <p class="note">Stops after the first code. Use <b>Scan Again</b> to read another.</p>
        </div>

        <div id="results" class="qr-results" aria-live="polite" aria-atomic="false">
          <div class="qr-result" id="emptyMsg">
            <div class="qr-badges">
              <span class="qr-badge">On-device</span>
              <span class="qr-badge">No uploads</span>
              <span class="qr-badge">Open/Copy/Share</span>
            </div>
            <p class="note" style="margin:6px 0 0;">No codes yet. Enable the camera or upload an image.</p>
          </div>
        </div>

        <details id="help">
          <summary><b>How it works & permission tips</b></summary>
          <ul class="note" style="margin:.5rem 0 0; padding-left:1rem;">
            <li><b>HTTPS required</b> (or <code>localhost</code>) for camera access.</li>
            <li>If this page is inside an <b>iframe</b>, the parent must set <code>allow="camera;microphone"</code> and your server's <code>Permissions-Policy</code> must allow <code>camera</code>.</li>
            <li><b>We auto-start</b> once permission is granted and <b>auto-stop</b> after first detection.</li>
            <li><b>Browser support</b>: auto-fallback if <code>BarcodeDetector</code> is unavailable.</li>
          </ul>
        </details>

        <figure class="qr-youtube" aria-labelledby="yt-title" style="margin:4px 0 0;">
          <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/5v9fN6xw8wU"
                  title="How to scan QR codes in your browser" loading="lazy"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          <figcaption id="yt-title" class="visually-hidden">Demo: scanning QR codes in a web browser</figcaption>
        </figure>

        <div id="adSlotMount"></div>
      </section>
    </main>

    <!-- Footer backlinks -->
    <footer class="container" style="padding:10px 16px 18px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
      <div class="chips">
        <a class="chip" href="/qr-generator/"><span class="text-logo" aria-hidden="true">QR</span> Create QR</a>
        <a class="chip" href="/image-converter/"><span class="text-logo" aria-hidden="true">IC</span> Image Converter</a>
        <a class="chip" href="/image-tool/"><span class="text-logo" aria-hidden="true">IT</span> Image Tools</a>
        <a class="chip" href="/currency-converter/"><span class="text-logo" aria-hidden="true">CC</span> Currency</a>
        <a class="chip" href="/ifsc-finder/"><span class="text-logo" aria-hidden="true">IF</span> IFSC Finder</a>
        <a class="chip" href="/sitemap.xml"><span class="text-logo" aria-hidden="true">SM</span> Sitemap</a>
      </div>
      <small class="note">Â© <span id="year"></span> UpTools - Privacy-first utilities.</small>
    </footer>
  </div>

  <!-- "Help" modal -->
  <div id="permModal" class="cta" aria-hidden="true">
    <div class="cta-card" role="dialog" aria-modal="true" aria-labelledby="permTitle" aria-describedby="permDesc">
      <h2 id="permTitle">Didn't see a camera prompt?</h2>
      <div id="permDesc" class="note" style="text-align:left">
        <p><b>1) Check HTTPS</b> - open this page at <code>https://</code> or on <code>localhost</code>.</p>
        <p><b>2) If embedded</b> - parent iframe must include <code>allow="camera;microphone"</code> and headers must allow <code>camera</code> in <code>Permissions-Policy</code>.</p>
        <p><b>3) Reset site permission</b> - padlock icon â†’ Site settings â†’ Camera â†’ Ask/Allow.</p>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="modalClose" class="btn">Got it</button>
      </div>
    </div>
  </div>

  <noscript>
    <div class="container" style="margin:1rem auto;">
      <p><b>JavaScript required:</b> Camera and QR decoding need JavaScript enabled.</p>
    </div>
  </noscript>

  <!-- Page logic (ESM) -->
  <script type="module">
    import { $, setText } from "/scripts/utils.js";

    // Elements
    const els = {
      video: $('#qrVideo'),
      overlay: $('#qrOverlay'),
      videoWrap: $('#videoWrap'),
      tapToEnable: $('#tapToEnable'),
      btnEnable: $('#btnEnable'),
      btnHelp: $('#btnHelp'),
      btnAgain: $('#btnAgain'),
      btnStop: $('#btnStop'),
      btnTorch: $('#btnTorch'),
      btnSnap: $('#btnSnap'),
      btnSwitch: $('#btnSwitch'),
      btnClear: $('#btnClear'),
      cameraSel: $('#cameraSel'),
      resSel: $('#resSel'),
      fileInput: $('#fileInput'),
      results: $('#results'),
      emptyMsg: $('#emptyMsg'),
      adMount: $('#adSlotMount'),
      permText: $('#permText'),
      permModal: $('#permModal'),
      modalClose: $('#modalClose'),
      btnScanScreen: $('#btnScanScreen')
    };
    const ctx = els.overlay.getContext('2d');

    // State
    let stream = null;
    let currentDeviceId = null;
    let scanning = false;
    let foundOnce = false;      // NEW: stop after first detection
    let ZX = null;              // ZXing ESM namespace
    let zxingReader = null;     // ZXing reader instance
    let barcodeDetector = null;
    let useBarcodeDetector = false;

    // Environment checks
    const isHttpsLike = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const inIframe = (()=>{ try { return window.top !== window.self; } catch { return true; } })();
    if (!isHttpsLike) {
      els.permText.innerHTML = 'Open this page over <b>HTTPS</b> (or <code>localhost</code>) to access the camera.';
    }
    if (inIframe) {
      els.permText.innerHTML += ' If embedded, parent <code>&lt;iframe&gt;</code> must include <code>allow="camera;microphone"</code> and your server must not block <code>camera</code> via <code>Permissions-Policy</code>.';
    }

    // Helpers
    const notify = (msg) => {
      const n = Object.assign(document.createElement('div'), { textContent: msg });
      n.style.cssText = 'position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1326;border:1px solid #234;padding:8px 12px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:9999';
      document.body.appendChild(n); setTimeout(()=> n.remove(), 1600);
    };
    const resolutionConstraints = (val)=>{
      switch(val){
        case 'hd': return { width:{ideal:1280}, height:{ideal:720} };
        case 'fhd': return { width:{ideal:1920}, height:{ideal:1080} };
        case 'uhd': return { width:{ideal:2560}, height:{ideal:1440} };
        default: return {};
      }
    };

    async function listCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d => d.kind === 'videoinput');
        els.cameraSel.innerHTML = '';
        vids.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId || '';
          opt.textContent = d.label || `Camera ${i+1}`;
          els.cameraSel.appendChild(opt);
        });
        if (vids.length && !currentDeviceId){
          const back = vids.find(d => /back|rear|environment/i.test(d.label));
          currentDeviceId = (back || vids[0]).deviceId || undefined;
        }
        if (currentDeviceId) els.cameraSel.value = currentDeviceId;
      }catch{}
    }

    async function startStream(){
      await stopStream();               // ensure clean start
      foundOnce = false;                // allow a new detection
      const deviceId = els.cameraSel.value || currentDeviceId;
      currentDeviceId = deviceId || undefined;
      const constraints = {
        video: { ...(deviceId ? { deviceId:{ exact: deviceId } } : { facingMode:{ ideal:'environment' } }), ...resolutionConstraints(els.resSel.value) },
        audio: false
      };
      try{
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;
        await els.video.play().catch(()=>{});
        resizeOverlayToWrap();
        els.btnStop.disabled = false;
        els.btnAgain.disabled = true;
        els.tapToEnable.classList.add('hide');
        await enableTorchIfAvailable();
        await runScanner();
        els.permText.textContent = 'Scanningâ€¦ (will pause after first code)';
        els.btnEnable.textContent = 'Camera Allowed âœ…';
        els.btnEnable.disabled = true;
        await listCameras(); // after permission granted, labels populate
      }catch(err){
        if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
          els.permText.textContent = 'Permission was blocked. Tap Help for steps or use Upload Image.';
          openModal();
        } else if (err && err.name === 'NotFoundError') {
          els.permText.textContent = 'No camera found. Try Upload Image or Scan Screen.';
        } else {
          notify('Camera error: ' + (err?.message || err));
        }
        throw err;
      }
    }

    async function stopStream(){
      scanning = false;
      if (zxingReader){ try{ zxingReader.reset(); }catch{} }
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      els.btnStop.disabled = true;
      ctx && ctx.clearRect(0,0,els.overlay.width,els.overlay.height);
      els.tapToEnable.classList.toggle('hide', !!(navigator.permissions && (await canAutoStart())));
      els.btnAgain.disabled = false;     // enable rescan button
    }

    async function canAutoStart(){
      if (!navigator.permissions?.query) return false;
      try {
        const st = await navigator.permissions.query({ name:'camera' });
        return st.state === 'granted';
      } catch { return false; }
    }

    async function enableTorchIfAvailable(){
      try{
        const track = stream?.getVideoTracks?.()[0];
        const caps = track?.getCapabilities?.();
        els.btnTorch.disabled = !(caps && 'torch' in caps);
      }catch{ els.btnTorch.disabled = true; }
    }
    async function toggleTorch(){
      try{
        const track = stream?.getVideoTracks?.()[0]; if (!track) return;
        const caps = track.getCapabilities?.(); if (!caps || !('torch' in caps)) return;
        const settings = track.getSettings?.() || {};
        const torchOn = !settings.torch;
        await track.applyConstraints({ advanced:[{ torch: torchOn }] });
        notify(torchOn ? 'Torch on' : 'Torch off');
      }catch{ notify('Torch not available on this device.'); }
    }

    async function ensureZXing(){ if (!ZX) ZX = await import('https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm'); }
    async function runScanner(){
      scanning = true;
      if ('BarcodeDetector' in window){ if (!barcodeDetector){ try{ barcodeDetector = new window.BarcodeDetector({ formats:['qr_code'] }); }catch{} } }
      useBarcodeDetector = !!barcodeDetector;
      if (useBarcodeDetector){
        loopBarcodeDetector();
      } else {
        await ensureZXing();
        if (!zxingReader) zxingReader = new ZX.BrowserQRCodeReader();
        zxingReader.decodeFromVideoDevice(currentDeviceId || undefined, els.video, (res)=>{
          if (!scanning || foundOnce) return;
          ctx.clearRect(0,0,els.overlay.width,els.overlay.height);
          if (res?.resultPoints?.length){
            ctx.beginPath(); ctx.strokeStyle='rgba(0,255,180,.9)'; ctx.lineWidth=3;
            res.resultPoints.forEach((p,i)=> (i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y)));
            ctx.closePath(); ctx.stroke();
          }
          if (res?.getText?.()) handleFound(res.getText(), { from:'camera' });
        });
      }
    }
    async function loopBarcodeDetector(){
      if (!scanning || !barcodeDetector || foundOnce) return;
      try{
        const detections = await barcodeDetector.detect(els.video);
        ctx.clearRect(0,0,els.overlay.width,els.overlay.height);
        if (detections?.length){
          const first = detections[0];
          if (first?.boundingBox){
            ctx.strokeStyle='rgba(0,255,180,.9)'; ctx.lineWidth=3;
            ctx.strokeRect(first.boundingBox.x, first.boundingBox.y, first.boundingBox.width, first.boundingBox.height);
          }
          handleFound(first.rawValue, { from:'camera', count:detections.length });
          return; // stop after first
        }
      }catch{
        useBarcodeDetector = false; await runScanner(); return;
      }
      if (scanning && !foundOnce) requestAnimationFrame(loopBarcodeDetector);
    }

    // NEW: unified handler that stops scanning after first detection
    async function handleFound(text, meta={}){
      if (foundOnce) return;
      foundOnce = true;
      addResult(text, meta);
      notify('Scanned âœ”');
      await stopStream();              // stop immediately after first result
    }

    // Frame snap (manual)
    async function snapScan(){
      if (!els.video.videoWidth) return notify('Video not ready');
      const w = els.video.videoWidth, h = els.video.videoHeight;
      const c = document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(els.video, 0, 0, w, h);
      let found = false;
      if (useBarcodeDetector && barcodeDetector){
        try{
          const det = await barcodeDetector.detect(c);
          if (det?.length){ handleFound(det[0].rawValue, { from:'snapshot', count:det.length }); found = true; }
        }catch{}
      }
      if (!found){
        await ensureZXing();
        const reader = new ZX.BrowserQRCodeReader();
        try{
          const res = await reader.decodeFromImage(c);
          if (res?.getText()) handleFound(res.getText(), { from:'snapshot' });
          else notify('No QR found in this frame.');
        }catch{ notify('No QR found in this frame.'); }
      }
    }

    // Image upload
    async function scanFile(file){
      if (!file) return;
      let found = false;
      if ('BarcodeDetector' in window){
        try{
          const bmp = await createImageBitmap(file);
          const det = await (barcodeDetector || new BarcodeDetector({ formats:['qr_code'] })).detect(bmp);
          if (det?.length){ handleFound(det[0].rawValue, { from:'image', count:det.length }); found = true; }
        }catch{}
      }
      if (!found){
        await ensureZXing();
        try{
          const url = URL.createObjectURL(file);
          const res = await new ZX.BrowserQRCodeReader().decodeFromImageUrl(url);
          if (res?.getText()) handleFound(res.getText(), { from:'image' });
          else notify('No QR found in image.');
          URL.revokeObjectURL(url);
        }catch{ notify('No QR found in image.'); }
      }
    }

    // Screen capture (desktop)
    async function scanScreen(){
      if (!navigator.mediaDevices?.getDisplayMedia){ notify('Screen capture not supported.'); return; }
      try{
        const disp = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
        const v = document.createElement('video');
        v.srcObject = disp; await v.play();
        const c = document.createElement('canvas');
        c.width = v.videoWidth || 1280; c.height = v.videoHeight || 720;
        c.getContext('2d').drawImage(v,0,0,c.width,c.height);
        const blob = await (await fetch(c.toDataURL())).blob();
        await scanFile(blob);
        disp.getTracks().forEach(t=>t.stop());
      }catch{ notify('Screen capture cancelled.'); }
    }

    // Results
    function addResult(raw, meta={}){
      if (els.emptyMsg) els.emptyMsg.remove();
      const { type, parsed } = analyzePayload(raw);
      const card = document.createElement('div');
      card.className = 'qr-result';

      const badges = document.createElement('div');
      badges.className = 'qr-badges';
      const b1 = document.createElement('span'); b1.className='qr-badge'; b1.textContent = type; badges.appendChild(b1);
      if (meta.from){ const b2 = document.createElement('span'); b2.className='qr-badge'; b2.textContent = `source: ${meta.from}`; badges.appendChild(b2); }
      if (meta.count && meta.count>1){ const b3 = document.createElement('span'); b3.className='qr-badge'; b3.textContent = `${meta.count} codes`; badges.appendChild(b3); }
      card.appendChild(badges);

      const actions = document.createElement('div');
      actions.className = 'qr-actions';
      actions.style.cssText = 'margin-top:4px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px';

      const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='Copy';
      copyBtn.addEventListener('click', async ()=>{ await navigator.clipboard?.writeText(raw); notify('Copied!'); });
      const shareBtn = document.createElement('button'); shareBtn.className='btn'; shareBtn.textContent='Share';
      shareBtn.addEventListener('click', async ()=>{
        if (navigator.share) { try { await navigator.share({ text: raw }); } catch{} }
        else { await navigator.clipboard?.writeText(raw); notify('Copied to clipboard (sharing not supported).'); }
      });
      actions.append(copyBtn, shareBtn);

      if (parsed?.href){
        const openA = document.createElement('a'); openA.className='btn'; openA.href = parsed.href; openA.target='_blank'; openA.rel='noopener'; openA.textContent='Open';
        actions.appendChild(openA);
      } else {
        const openBtn = document.createElement('button'); openBtn.className='btn'; openBtn.disabled = true; openBtn.textContent='Open';
        actions.appendChild(openBtn);
      }
      card.appendChild(actions);

      if (parsed?.wifi){
        const p = document.createElement('p'); p.className='note';
        p.innerHTML = `Wi-Fi: <b>${(parsed.wifi.ssid || '')}</b> (${(parsed.wifi.auth || 'nopass')})`;
        card.appendChild(p);
      }
      if (parsed?.vcard){
        const p = document.createElement('p'); p.className='note';
        p.innerHTML = `Contact: <b>${(parsed.vcard.fn || parsed.vcard.n || 'Unknown')}</b>`;
        card.appendChild(p);
      }
      const pre = document.createElement('pre'); pre.textContent = raw;
      card.appendChild(pre);

      els.results.prepend(card);
    }

    function analyzePayload(t){
      const s = (t||'').trim();
      try { const u = new URL(s); return { type:'URL', parsed:{ href:u.href } }; } catch{}
      if (/^WIFI:/i.test(s)){
        const obj = {}; s.replace(/^WIFI:/i,'').split(';').forEach(part=>{ const [k,v] = part.split(':'); if (k && v) obj[k]=v; });
        return { type:'Wi-Fi', parsed:{ wifi:{ auth:obj.T||'nopass', ssid:obj.S||'', pass:obj.P||'' } } };
      }
      if (/^BEGIN:VCARD/i.test(s) || /^MECARD:/i.test(s)){
        const v = {}; (s.split(/\r?\n|;/)).forEach(line=>{ const [k,...rest]=line.split(':'); const val = rest.join(':'); if (/^(FN|N|TEL|EMAIL|ORG|TITLE)$/i.test(k||'')) v[k.toLowerCase()] = val; });
        return { type:'Contact', parsed:{ vcard:v } };
      }
      if (/^mailto:/i.test(s)) return { type:'Email', parsed:{ href:s } };
      if (/^tel:/i.test(s)) return { type:'Phone', parsed:{ href:s } };
      if (/^sms:/i.test(s)) return { type:'SMS', parsed:{ href:s } };
      if (/^geo:/i.test(s)) return { type:'Map', parsed:{ href:s } };
      return { type:'Text', parsed:null };
    }

    // Canvas sizing
    function resizeOverlayToWrap(){
      const w = Math.max(320, Math.round(els.videoWrap.clientWidth));
      const h = Math.max(240, Math.round(els.videoWrap.clientHeight));
      if (els.overlay.width !== w || els.overlay.height !== h){ els.overlay.width = w; els.overlay.height = h; ctx.clearRect(0,0,w,h); }
    }
    new ResizeObserver(resizeOverlayToWrap).observe(els.videoWrap);

    // Modal helpers
    const openModal = () => { els.permModal.classList.add('show'); els.permModal.setAttribute('aria-hidden','false'); };
    const closeModal = () => { els.permModal.classList.remove('show'); els.permModal.setAttribute('aria-hidden','true'); };

    // Events
    els.btnEnable.onclick = startStream;
    els.tapToEnable.onclick = startStream;
    els.btnHelp.onclick = openModal;
    els.modalClose.onclick = closeModal;

    els.btnAgain.onclick = startStream;          // rescan
    els.btnStop.onclick = stopStream;
    els.btnTorch.onclick = toggleTorch;
    els.btnSnap.onclick = snapScan;
    els.btnSwitch.onclick = async ()=> {
      const opts = Array.from(els.cameraSel.options); if (!opts.length) return;
      const idx = Math.max(0, (opts.findIndex(o=>o.value===els.cameraSel.value)+1) % opts.length);
      els.cameraSel.selectedIndex = idx; currentDeviceId = els.cameraSel.value; await startStream();
    };
    els.btnClear.onclick = ()=> { els.results.innerHTML = ''; const m = document.createElement('div'); m.id='emptyMsg'; m.className='qr-result'; m.innerHTML = '<p class="note">Cleared.</p>'; els.results.appendChild(m); };
    els.fileInput.onchange = (e)=> scanFile(e.target.files?.[0]);
    ['dragenter','dragover'].forEach(ev => els.videoWrap.addEventListener(ev, e => { e.preventDefault(); e.dataTransfer.dropEffect='copy'; }));
    els.videoWrap.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files?.[0]; if (f) scanFile(f); });
    els.resSel.onchange = async ()=> { if (stream) await startStream(); };
    els.cameraSel.onchange = async ()=> { currentDeviceId = els.cameraSel.value; if (stream) await startStream(); };
    els.btnScanScreen.onclick = scanScreen;

    // Footer year
    setText($('#year'), new Date().getFullYear());

    // Inject ad if available (avoid CLS)
    (function injectAd(){
      if (!('adsbygoogle' in window) || !els.adMount) return;
      const cont = document.createElement('div');
      cont.innerHTML = `<ins class="adsbygoogle" style="display:block;min-height:90px" data-ad-client="ca-pub-6216304334889617" data-ad-slot="5880770000" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
      els.adMount.appendChild(cont);
      try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch {}
    })();

    // Init
    resizeOverlayToWrap();

    // Auto-start if already granted (no Start button needed)
    (async () => {
      if (await canAutoStart()) {
        els.btnEnable.disabled = true; els.btnEnable.textContent = 'Camera Allowed âœ…';
        els.tapToEnable.classList.add('hide');
        try { await listCameras(); await startStream(); } catch {}
      }
    })();
  </script>

  <!--
  Server headers for Cloudflare Pages (_headers in /public or Custom headers):
    /qr-reader/*
      Permissions-Policy: camera=(self), microphone=()
  If you embed this page:
    <iframe src="https://www.uptools.in/qr-reader/" allow="camera;microphone"></iframe>
  -->
</body>
</html>
