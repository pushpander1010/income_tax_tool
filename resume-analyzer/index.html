<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Ads load conditionally; slot space is reserved below to avoid CLS -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6216304334889617" crossorigin="anonymous"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Free Resume ATS Checker & JD Match (AI) ‚Äî Perplexity / Gemini / Groq | UpTools</title>

  <!-- Canonical + Icons -->
  <link rel="canonical" href="https://www.uptools.in/resume-analyzer/">
  <link rel="icon" sizes="50x50" type="image/svg+xml" href="/assets/logo/uptools-logo.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/uptools-logo.svg">

  <!-- SEO -->
  <meta name="description" content="Free AI Resume ATS Checker: upload resume (PDF/DOCX/TXT) and optionally paste a job description for keyword match. Reports ATS score, missing skills, and tailoring tips. Choose Perplexity, Google Gemini 2.5, or Groq.">
  <meta name="keywords" content="resume ats checker, resume checker, ats resume, job description match, resume keywords, free ats checker, resume parser, cv checker">
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:large">
  <meta name="theme-color" content="#0b1020">

  <!-- Open Graph -->
  <meta property="og:title" content="Free Resume ATS Checker & JD Match (AI) | UpTools">
  <meta property="og:description" content="Upload resume and match with any JD. See ATS score, missing keywords, and instant improvement tips. Perplexity ‚Ä¢ Gemini 2.5 ‚Ä¢ Groq.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.uptools.in/resume-analyzer/">
  <meta property="og:site_name" content="UpTools">
  <meta property="og:image" content="https://www.uptools.in/assets/og/resume-ats-checker.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">

  <!-- CSS -->
  <link rel="preload" href="/style.css" as="style">
  <link rel="stylesheet" href="/style.css">
  <link rel="modulepreload" href="/scripts/utils.js">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"Resume ATS Checker & JD Match",
    "applicationCategory":"BusinessApplication",
    "operatingSystem":"Web",
    "offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},
    "publisher":{"@type":"Organization","name":"UpTools","url":"https://www.uptools.in/"},
    "url":"https://www.uptools.in/resume-analyzer/",
    "featureList":["ATS score","JD keyword match","Missing skills","Tailoring suggestions","Downloadable report"]
  }
  </script>

  <style>
    /* Page-level tokens (reuse common theme but allow subtle overrides) */
    :root{
      --panel-h: clamp(560px, 82dvh, 820px);
      --gap: 14px;
    }

    main.tool { max-width: 1200px; margin-inline: auto; padding: 12px var(--container-px, 12px); }

    /* 2 columns on desktop ‚Üí 1 column on tablet/mobile */
    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items: stretch;
    }
    @media (max-width: 1024px){ .grid{ grid-template-columns: 1fr; } }

    /* Panels: make content scroll within, not overflow page (fixes overlap) */
    .panel{
      display: flex; flex-direction: column;
      min-height: 420px; height: var(--panel-h);
      overflow: hidden; border-radius: var(--radius);
      contain: layout paint;
    }
    @media (max-width: 800px){
      .panel{ height: auto; min-height: 0; overflow: visible; }
    }
    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:10px 12px; flex-wrap:wrap;
    }
    .panel-body{
      flex:1; min-height:0; /* crucial to let inner scroll areas size properly */
      display:grid; grid-template-rows:auto 1fr auto; gap:10px; padding:10px 12px;
    }

    /* Toolbars wrap on small screens ‚Äî no more overlap */
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .inline{ display:inline-flex; align-items:center; gap:6px; flex-wrap:wrap; }

    /* Text areas and output are scrollable blocks (no fixed heights) */
    .area{ display:grid; grid-template-columns:1fr; gap:8px; }
    textarea.input{
      width:100%; resize:vertical; min-height:140px; max-height:min(40dvh,520px);
      padding:10px 12px; line-height:1.45; border-radius:12px;
    }
    pre.output{
      width:100%; margin:0; padding:12px 14px; border-radius:12px;
      background:#121826; border:1px solid var(--border);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      line-height:1.55; white-space:pre-wrap; word-break:break-word; overflow:auto;
      min-height:clamp(220px, 28dvh, 360px); max-height:min(46dvh, 560px);
    }
    @media (max-width: 800px){
      textarea.input{ max-height:unset; }
      pre.output{ max-height:unset; }
    }

    /* KPI tiles (wrap safely) */
    .kpis{ display:flex; flex-wrap:wrap; gap:10px; }
    .kpi{ flex:1 1 180px; padding:10px; border-radius:10px; background:#0a1224; border:1px solid var(--border); box-shadow:var(--glow-soft); }
    .kpi b{ font-size:18px; display:block; }

    .tiny{ font-size:12px; opacity:.85; }

    /* Ad slot: reserved height to prevent CLS */
    .ad-wrap{ display:block; min-height:160px; margin:10px 0; position:relative; overflow:hidden; }
    @media (min-width: 1024px){ .ad-wrap{ min-height: 250px; } }
    .ad-wrap:empty::before{ content:""; display:block; width:100%; height:100%; }

    /* Styled ‚ÄúChoose File‚Äù control (uses a hidden input) */
    .file-chooser{
      position:relative; display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none;
      background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent-2) 70%, white));
      color:#071018; border:1px solid color-mix(in oklab, var(--accent) 65%, #223);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.25), var(--glow-soft);
      font-weight:900; letter-spacing:.2px;
    }
    .file-chooser:hover{ transform: translateY(-1px); filter: saturate(1.06); box-shadow: var(--glow); }
    .file-chooser input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .file-meta{ font-size:12px; color:var(--muted); }

    /* Helper grid for inputs so controls never collide */
    .row{ display:grid; gap:8px; grid-template-columns: 1fr 1fr; align-items:end; }
    @media (max-width: 900px){ .row{ grid-template-columns: 1fr; } }

    /* Danger/secondary buttons tiny variants */
    .btn.sm{ padding:5px 10px; min-height:30px; font-size:12px; }
    .btn.danger{ background: transparent; color:#ffb4b4; border:1px solid color-mix(in oklab, red 60%, #223); }

    /* Links list area */
    .tips-related{ display:grid; gap:12px; grid-template-columns:1fr 1fr; align-items:start; }
    @media (max-width: 800px){ .tips-related{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="site" role="banner">
    <div class="header-inner">
      <a class="brand" href="/" aria-label="UpTools Home">
        <img src="/assets/logo/uptools-logo.svg" alt="UpTools logo" width="28" height="28" loading="eager">
        <b>UpTools</b>
      </a>
      <nav class="nav-links" aria-label="Primary">
        <a href="/#tools">Tools</a>
        <a href="/ai-writer/">AI Writer</a>
        <a href="/word-counter/">Word Counter</a>
        <a aria-current="page" href="/resume-analyzer/">Resume ATS</a>
      </nav>
    </div>
  </header>

  <main class="tool container" id="top">
    <!-- Hero -->
    <section class="card hero" aria-labelledby="title">
      <div>
        <h1 id="title">üßæüîç Resume ATS Checker & JD Match (AI)</h1>
        <p class="note" style="margin:0">Upload your resume (PDF/DOCX/TXT) and optionally paste a Job Description. Get ATS score, missing keywords, and tailored rewrite tips. Choose Perplexity, Google Gemini 2.5, or Groq.</p>
        <div class="chips" style="margin-top:8px">
          <span class="pill">‚ö° Streams live</span>
          <span class="pill">üîí Proxy ‚Äî no browser API key</span>
          <a class="chip" href="/sitemap.xml">Sitemap</a>
          <a class="chip" href="/about/"><span class="card-badge" aria-hidden="true">ABT</span> About</a>
          <a class="chip" href="/contact/"><span class="card-badge" aria-hidden="true">CT</span> Contact</a>
        </div>
      </div>
    </section>

    <!-- Reserved ad slot (prevents CLS) -->
    <section id="adMount" class="ad-wrap" aria-label="Advertisement area"></section>

    <!-- Workspace -->
    <section class="grid" aria-label="Workspace">
      <!-- LEFT: INPUT -->
      <article class="panel card" aria-labelledby="input-title">
        <div class="panel-head">
          <h2 id="input-title" class="h4">Your Resume & JD</h2>
          <div class="toolbar">
            <span class="tiny">Chars: <output id="charCount">0</output></span>
            <button id="pasteResume" class="btn sm" type="button">Paste Resume</button>
            <button id="clearAll" class="btn sm secondary" type="button">Clear</button>
          </div>
        </div>

        <div class="panel-body">
          <div class="row">
            <!-- File chooser styled -->
            <label class="inline" style="gap:10px">
              <span class="file-chooser" title="Upload resume (PDF/DOC/DOCX/TXT)">
                <span>üìÑ Choose File</span>
                <input id="resumeFile" type="file" accept=".pdf,.docx,.txt,.doc" aria-label="Upload resume">
              </span>
              <span id="fileMeta" class="file-meta">Accepted: PDF, DOCX, DOC, TXT (light client-side parsing)</span>
            </label>

            <!-- Provider + model -->
            <div class="inline" role="group" aria-label="AI settings">
              <label class="inline"><span class="tiny">Provider</span>
                <select id="provider" class="select" style="width:170px">
                  <option value="perplexity" selected>Perplexity</option>
                  <option value="google">Google (Gemini)</option>
                  <option value="groq">Groq</option>
                </select>
              </label>
              <label class="inline"><span class="tiny">Model</span>
                <select id="modelSel" class="select" style="width:230px"></select>
              </label>
              <button id="saveCfg" class="btn sm secondary" type="button" title="Save provider & model">Save</button>
            </div>
          </div>

          <div class="area">
            <label class="label" for="resumeText">Resume Text</label>
            <textarea id="resumeText" class="input" placeholder="Paste your resume text or upload a file above‚Ä¶" spellcheck="false"></textarea>
          </div>

          <div class="area">
            <div class="inline" style="justify-content:space-between; width:100%">
              <label class="label" for="jdText" style="margin:0">Job Description (optional for match analysis)</label>
              <div class="toolbar">
                <button id="pasteJD" class="btn sm secondary" type="button">Paste JD</button>
                <button id="swapBtn" class="btn sm ghost" type="button" title="Swap Resume ‚Üî JD">Swap</button>
              </div>
            </div>
            <textarea id="jdText" class="input" placeholder="Paste a job description to check keyword match‚Ä¶" spellcheck="false"></textarea>
          </div>

          <!-- Actions -->
          <div class="toolbar">
            <label class="inline"><span class="tiny">Mode</span>
              <select id="mode" class="select" style="width:220px">
                <option value="ats" selected>ATS Score (general)</option>
                <option value="match">ATS + JD Match</option>
                <option value="rewrite">Rewrite Resume for JD</option>
              </select>
            </label>

            <button id="runBtn" class="btn" type="button">Analyze ‚ñ∂</button>
            <button id="stopBtn" class="btn sm danger" type="button" disabled>Stop</button>
          </div>
        </div>
      </article>

      <!-- RIGHT: OUTPUT -->
      <article class="panel card" aria-labelledby="output-title">
        <div class="panel-head">
          <h2 id="output-title" class="h4">Results</h2>
          <div class="toolbar">
            <button id="copyBtn" class="btn sm" type="button">Copy</button>
            <button id="downloadBtn" class="btn sm" type="button">Download .txt</button>
            <button id="permBtn" class="btn sm secondary" type="button" title="Create a shareable link with your settings">Permalink</button>
          </div>
        </div>

        <div class="panel-body">
          <div class="kpis" id="kpis" aria-live="polite">
            <div class="kpi"><span class="tiny">ATS Score</span><b id="kpiATS">‚Äî</b></div>
            <div class="kpi"><span class="tiny">JD Match</span><b id="kpiMatch">‚Äî</b></div>
            <div class="kpi"><span class="tiny">Missing Keywords</span><b id="kpiMissing">‚Äî</b></div>
            <div class="kpi"><span class="tiny">Readability</span><b id="kpiRead">‚Äî</b></div>
          </div>
          <div class="tiny" id="status" aria-live="polite" style="min-height:1.2em"></div>
          <pre id="output" class="output" tabindex="0" aria-label="AI output"></pre>

          <div class="tips-related">
            <div>
              <h3 class="h5">Tips</h3>
              <ul class="list compact">
                <li>Keep section headers simple: <i>Experience</i>, <i>Education</i>, <i>Skills</i>.</li>
                <li>Mirror exact JD keywords where truthful (tools, frameworks, certifications).</li>
                <li>Use simple tables only; avoid multi-column PDFs for ATS.</li>
              </ul>
            </div>
            <div>
              <h3 class="h5">Related</h3>
              <ul class="list compact">
                <li><a href="/ai-writer/">AI Writer</a> ‚Äî rewrite bullets by impact.</li>
                <li><a href="/word-counter/">Word Counter</a> ‚Äî length & reading time.</li>
                <li><a href="/plagiarism-checker/">Plagiarism Checker</a> ‚Äî originality estimate.</li>
              </ul>
            </div>
          </div>
        </div>
      </article>
    </section>

    <!-- Footer links -->
    <section class="spaced" aria-labelledby="related">
      <h2 id="related" class="h5">More from UpTools</h2>
      <div class="grid" style="grid-template-columns: repeat(4,1fr);">
        <a class="card tool-link accent-indigo" href="/json-formatter/"><span class="ico" aria-hidden="true">üß©</span><span><b>JSON Formatter</b><br><span class="note">Prettify & validate</span></span></a>
        <a class="card tool-link accent-emerald" href="/qr-generator/"><span class="ico" aria-hidden="true">üî≥</span><span><b>QR Generator</b><br><span class="note">Create QR codes</span></span></a>
        <a class="card tool-link accent-cyan" href="/image-converter/"><span class="ico" aria-hidden="true">üñºÔ∏è</span><span><b>Image Converter</b><br><span class="note">Resize & format</span></span></a>
        <a class="card tool-link accent-violet" href="/ai-writer/"><span class="ico" aria-hidden="true">‚úçÔ∏è</span><span><b>AI Writer</b><br><span class="note">Summarize & rewrite</span></span></a>
      </div>
    </section>

    <footer class="site-footer">
      <nav class="nav-links" aria-label="Footer">
        <a href="/about/"><span class="card-badge" aria-hidden="true">ABT</span> About</a>
        <a href="/contact/"><span class="card-badge" aria-hidden="true">CT</span> Contact</a>
        <a href="/privacy/"><span class="card-badge" aria-hidden="true">PP</span> Privacy</a>
      </nav>
      <p class="tiny">¬© <span id="y"></span> UpTools ¬∑ Privacy-first utilities</p>
    </footer>
  </main>

  <script type="module">
    import { $, $$, debounce, persist, read } from '/scripts/utils.js';

    // Refs
    const byId = (id)=>document.getElementById(id);
    const resumeFile = byId('resumeFile');
    const fileMeta = byId('fileMeta');
    const resumeText = byId('resumeText');
    const jdText = byId('jdText');
    const pasteResume = byId('pasteResume');
    const pasteJD = byId('pasteJD');
    const clearAll = byId('clearAll');
    const charCount = byId('charCount');

    const runBtn = byId('runBtn');
    const stopBtn = byId('stopBtn');
    const status = byId('status');
    const output = byId('output');
    const copyBtn = byId('copyBtn');
    const downloadBtn = byId('downloadBtn');
    const permBtn = byId('permBtn');

    const providerSel = byId('provider');
    const modelSel = byId('modelSel');
    const saveCfg = byId('saveCfg');
    const modeSel = byId('mode');

    // KPIs
    const kpiATS = byId('kpiATS');
    const kpiMatch = byId('kpiMatch');
    const kpiMissing = byId('kpiMissing');
    const kpiRead = byId('kpiRead');

    // Footer year
    byId('y').textContent = new Date().getFullYear();

    // Provider & Models
    const PROVIDER_MODELS = {
      perplexity: [
        { id: 'sonar', label: 'sonar' },
        { id: 'sonar-pro', label: 'sonar-pro' },
        { id: 'sonar-reasoning', label: 'sonar-reasoning' }
      ],
      google: [
        { id: 'gemini-2.5-flash', label: 'gemini-2.5-flash' },
        { id: 'gemini-2.5-pro', label: 'gemini-2.5-pro' }
      ],
      groq: [
        { id: 'llama-3.1-8b-instant', label: 'llama-3.1-8b-instant' },
        { id: 'llama-3.1-70b-versatile', label: 'llama-3.1-70b-versatile' },
        { id: 'mixtral-8x7b-32768', label: 'mixtral-8x7b-32768' },
        { id: 'gemma2-9b-it', label: 'gemma2-9b-it' }
      ]
    };

    const CFG_KEY = 'resume:cfg';
    const cfg = Object.assign({ provider: 'perplexity', model: 'sonar' }, read(CFG_KEY, {}));

    function populateModels(){
      const prov = providerSel.value || 'perplexity';
      const models = PROVIDER_MODELS[prov] || [];
      modelSel.innerHTML = '';
      for(const m of models){
        const opt=document.createElement('option');
        opt.value=m.id; opt.textContent=m.label;
        modelSel.appendChild(opt);
      }
      const ok = models.some(m => m.id === cfg.model);
      modelSel.value = ok ? cfg.model : (models[0]?.id || '');
    }

    providerSel.value = cfg.provider || 'perplexity';
    populateModels();
    if (cfg.model) modelSel.value = cfg.model;

    saveCfg.addEventListener('click', ()=>{
      persist(CFG_KEY, { provider: providerSel.value, model: modelSel.value });
      toast('Settings saved');
    });
    providerSel.addEventListener('change', ()=>{
      cfg.provider = providerSel.value; populateModels();
    });

    // Counts
    function updateCount(){
      const t = (resumeText.value || '') + (jdText.value || '');
      charCount.textContent = (t.length).toLocaleString();
    }
    resumeText.addEventListener('input', debounce(updateCount, 60));
    jdText.addEventListener('input', debounce(updateCount, 60));
    updateCount();

    // Paste/Clear
    pasteResume.addEventListener('click', async ()=>{
      try{ resumeText.value = await navigator.clipboard.readText(); updateCount(); }
      catch{ toast('Clipboard blocked by browser'); }
    });
    pasteJD.addEventListener('click', async ()=>{
      try{ jdText.value = await navigator.clipboard.readText(); updateCount(); }
      catch{ toast('Clipboard blocked by browser'); }
    });
    clearAll.addEventListener('click', ()=>{
      resumeText.value=''; jdText.value=''; output.textContent=''; status.textContent='';
      resetKPIs(); updateCount(); resumeText.focus();
    });

    // File parsing (lightweight: TXT natively; PDF/DOCX best-effort notice)
    resumeFile.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      fileMeta.textContent = `${f.name} ‚Ä¢ ${(f.size/1024/1024).toFixed(2)} MB`;
      const ext = (f.name.split('.').pop() || '').toLowerCase();

      try{
        if(ext === 'txt'){
          resumeText.value = await f.text();
        }else if(ext === 'pdf'){
          // Minimal ‚Äúsafe‚Äù fallback: show guidance if no PDF.js is wired.
          resumeText.value = (resumeText.value ? resumeText.value + '\n\n' : '') +
            '[Notice] PDF text extraction requires PDF.js on this page. If text below looks empty, open your PDF and copy-paste the text here for best results.';
        }else if(ext === 'doc' || ext === 'docx'){
          // Minimal fallback note (avoid heavy zip libs)
          resumeText.value = (resumeText.value ? resumeText.value + '\n\n' : '') +
            '[Notice] DOC/DOCX parsing is limited in-browser. If content is missing, please open the document and paste plain text here for best ATS accuracy.';
        }else{
          toast('Unsupported file type');
        }
        updateCount();
      }catch(e){
        toast('Could not read file. Try TXT or paste.');
      }
    });

    // Heuristics for KPIs (client-side quick estimates)
    function sentences(text){ return (text.trim().match(/[^.!?]+[.!?]*/g) || []).map(s=>s.trim()).filter(Boolean); }
    function flesch(text){
      const words=(text.match(/\b[a-zA-Z‚Äô'-]+\b/g)||[]);
      const syl=words.reduce((s,w)=>s+((w.toLowerCase().match(/[aeiouy]+/g)||[]).length||1),0);
      const S=sentences(text).length||1, W=Math.max(words.length,1);
      return Math.max(0, Math.min(100, 206.835 - 1.015*(W/S) - 84.6*(syl/W)));
    }
    function uniqKeywords(text){
      return new Set((text.toLowerCase().match(/\b[a-z][a-z0-9+\-.#]+\b/g) || []).filter(w=>w.length>2));
    }
    function quickATS(text){
      // lightweight proxy: length + structure + skills diversity
      const len = (text.match(/\b[a-zA-Z]/g)||[]).length;
      const secs = (text.match(/\b(experience|education|skills|projects|summary|certifications|work|achievements)\b/i)||[]).length;
      const kw = uniqKeywords(text).size;
      let score = 40;
      score += Math.min(25, Math.floor(len/1500)*5);
      score += Math.min(15, secs*5);
      score += Math.min(20, Math.floor(kw/100)*4);
      return Math.max(0, Math.min(100, score));
    }
    function matchRate(resume, jd){
      if(!jd.trim()) return 0;
      const rset = uniqKeywords(resume); const jset = uniqKeywords(jd);
      if(jset.size===0) return 0;
      let hit=0; jset.forEach(k=>{ if(rset.has(k)) hit++; });
      return Math.round((hit / jset.size) * 100);
    }
    function missingKeywords(resume, jd){
      const rset = uniqKeywords(resume); const jset = [...uniqKeywords(jd)];
      return jset.filter(k=>!rset.has(k)).slice(0, 50); // show top 50 max
    }
    function updateKPIs(){
      const r = resumeText.value || '';
      const j = jdText.value || '';
      kpiATS.textContent = (r.trim()? (quickATS(r))+'%' : '‚Äî');
      kpiMatch.textContent = (r.trim() && j.trim()? (matchRate(r,j))+'%' : (j.trim()? '0%' : '‚Äî'));
      kpiMissing.textContent = (r.trim() && j.trim()? missingKeywords(r,j).length : '‚Äî');
      kpiRead.textContent = (r.trim()? Math.round(flesch(r)) : '‚Äî');
    }
    function resetKPIs(){ kpiATS.textContent='‚Äî'; kpiMatch.textContent='‚Äî'; kpiMissing.textContent='‚Äî'; kpiRead.textContent='‚Äî'; }
    resumeText.addEventListener('input', debounce(updateKPIs, 120));
    jdText.addEventListener('input', debounce(updateKPIs, 120));

    // Swap fields
    byId('swapBtn').addEventListener('click', ()=>{
      const a = resumeText.value; resumeText.value = jdText.value; jdText.value = a;
      updateCount(); updateKPIs();
    });

    // Build model prompt
    function buildPrompt(mode, resume, jd){
      if(mode==='ats'){
        return [
          "You are an ATS optimization assistant.",
          "Analyze the resume for ATS readiness. Return:",
          "1) ATS score (0-100). 2) Strengths. 3) Gaps/risks. 4) Missing keywords (if obvious).",
          "5) Actionable rewrites: 3-6 bullet points.",
          "\n--- RESUME ---\n", resume
        ].join('\n');
      }
      if(mode==='match'){
        return [
          "You are an ATS optimization assistant.",
          "Compare resume vs JD. Return:",
          "1) ATS score (0-100). 2) JD match % (0-100). 3) Missing/weak keywords.",
          "4) Tailored rewrite suggestions (bullet points), using the JD language where truthful.",
          "\n--- RESUME ---\n", resume,
          "\n--- JOB DESCRIPTION ---\n", jd
        ].join('\n');
      }
      // rewrite
      return [
        "Rewrite this resume to better match the JD while preserving truthfulness.",
        "Keep original structure, measurable impact, and clear bullet points. Avoid jargon inflation.",
        "Return ONLY the revised resume text.",
        "\n--- RESUME ---\n", resume,
        "\n--- JOB DESCRIPTION ---\n", jd
      ].join('\n');
    }

    // Stream via /ai proxy
    let aborter = null;
    async function streamChat({ provider, model, prompt }){
      output.textContent = '';
      status.textContent = 'Running‚Ä¶';
      stopBtn.disabled = false;

      const res = await fetch('/ai', {
        method:'POST',
        signal: (aborter = new AbortController()).signal,
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          provider, model, stream:true, temperature:0.2,
          messages:[
            { role:'system', content:'You are a concise, careful assistant.' },
            { role:'user', content: prompt }
          ]
        })
      });
      if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
      const reader = res.body.getReader(); const dec=new TextDecoder(); let acc='';
      for(;;){
        const {value, done} = await reader.read(); if(done) break;
        const chunk = dec.decode(value, {stream:true});
        for(const raw of chunk.split('\n')){
          const line = raw.trim(); if(!line || !line.startsWith('data:')) continue;
          const payload = line.slice(5).trim(); if(payload==='[DONE]'){ aborter=null; return acc; }
          try{
            const json = JSON.parse(payload);
            const delta = json.choices?.[0]?.delta?.content ?? '';
            if(delta){ acc += delta; output.append(document.createTextNode(delta)); output.scrollTop = output.scrollHeight; }
          }catch{}
        }
      }
      aborter=null; return acc;
    }

    stopBtn.addEventListener('click', ()=>{
      if(aborter){ aborter.abort(); aborter=null; stopBtn.disabled=true; status.textContent='Stopped.'; }
    });

    runBtn.addEventListener('click', async ()=>{
      const resume = (resumeText.value||'').trim();
      const jd = (jdText.value||'').trim();
      if(!resume){ toast('Add resume text or upload a file.'); resumeText.focus(); return; }

      // quick KPIs first (no overlap/scroll glitches)
      updateKPIs();

      const provider = providerSel.value || 'perplexity';
      const model = modelSel.value || (PROVIDER_MODELS[provider]?.[0]?.id ?? '');
      if(!model){ toast('Pick a model'); return; }

      const mode = modeSel.value;
      const prompt = buildPrompt(mode, resume, jd);

      try{
        await streamChat({ provider, model, prompt });
        status.textContent = 'Done.';
      }catch(e){
        status.textContent = (e?.message||'Error') + ' ‚Äî check provider/model or quotas.';
        toast('Request failed.');
      }finally{
        stopBtn.disabled = true;
      }
    });

    // Copy/Download/Permalink
    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(output.textContent||''); toast('Copied'); }
      catch{ toast('Copy blocked by browser'); }
    });
    downloadBtn.addEventListener('click', ()=>{
      const blob=new Blob([output.textContent||''],{type:'text/plain;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='resume-ats-result.txt'; a.click();
      URL.revokeObjectURL(a.href);
    });
    permBtn.addEventListener('click', async ()=>{
      const o={ p: providerSel.value, m: modelSel.value, mode: modeSel.value };
      const url=new URL(location.href); url.hash=encodeURIComponent(btoa(JSON.stringify(o)));
      try{ await navigator.clipboard.writeText(url.toString()); toast('Permalink copied'); }
      catch{ toast('Permalink ready (check address bar)'); history.replaceState({},'',url); }
    });

    // Restore from hash
    (function restoreFromHash(){
      if(!location.hash) return;
      try{
        const o = JSON.parse(atob(decodeURIComponent(location.hash.slice(1))));
        if(o?.p) providerSel.value = o.p;
        populateModels();
        if(o?.m) modelSel.value = o.m;
        if(o?.mode) modeSel.value = o.mode;
      }catch{}
    })();

    // Mount AdSense without CLS (slot already reserved)
    (function mountAd(){
      if(!('adsbygoogle' in window)) return;
      const mount=byId('adMount');
      const ins=document.createElement('ins');
      ins.className='adsbygoogle';
      ins.setAttribute('data-ad-client','ca-pub-6216304334889617');
      ins.setAttribute('data-ad-slot','auto');
      ins.setAttribute('data-ad-format','auto');
      ins.setAttribute('data-full-width-responsive','true');
      ins.style.display='block';
      ins.style.minHeight='160px';
      mount.appendChild(ins);
      try{ (window.adsbygoogle = window.adsbygoogle || []).push({}); }catch{}
    })();

    function toast(msg){ status.textContent=msg; setTimeout(()=>{ if(status.textContent===msg) status.textContent=''; }, 1800); }
  </script>
</body>
</html>
