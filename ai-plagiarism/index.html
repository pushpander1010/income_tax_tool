<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Connection hints -->
  <link rel="preconnect" href="https://www.youtube.com" crossorigin>
  <link rel="dns-prefetch" href="//www.youtube.com">
  <link rel="preconnect" href="https://i.ytimg.com" crossorigin>
  <link rel="dns-prefetch" href="//i.ytimg.com">
  <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
  <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
  <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin>
  <link rel="dns-prefetch" href="//googleads.g.doubleclick.net">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Free AI Plagiarism Checker &amp; Paraphrasing Tool (Originality %) | UpTools</title>
  <meta name="description"
    content="Free AI Plagiarism Checker - estimate originality %, flag risky sentences, and fix with instant paraphrasing. Rewriter supports tones &amp; constraints. Works with Perplexity, Google Gemini 2.5, and Groq via secure proxy. No login." />
  <meta name="keywords"
    content="free plagiarism checker, paraphrasing tool, rewriter, originality checker, check plagiarism online, remove plagiarism, ai rewriter, paraphrase sentences" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:large" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="canonical" href="https://www.uptools.in/ai-plagiarism/" />

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="/assets/logo/uptools-logo.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <!-- Social -->
  <meta property="og:title" content="Free AI Plagiarism Checker &amp; Paraphrasing Tool | UpTools" />
  <meta property="og:description"
    content="Estimate originality %, highlight risky lines, and paraphrase instantly. Powered by Perplexity, Gemini 2.5 &amp; Groq. No sign-ups." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.uptools.in/ai-plagiarism/" />
  <meta property="og:site_name" content="UpTools" />
  <meta property="og:image" content="https://www.uptools.in/assets/og/ai-plagiarism-checker.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Load main stylesheet as normal (avoid FOUC->CLS), keep preload for speed -->
  <link rel="preload" href="/style.css" as="style">
  <link rel="stylesheet" href="/style.css">

  <!-- Utils -->
  <link rel="modulepreload" href="/scripts/utils.js">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "SoftwareApplication",
        "name": "AI Plagiarism Checker & Paraphraser",
        "applicationCategory": "UtilityApplication",
        "operatingSystem": "Web",
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
        "publisher": { "@type": "Organization", "name": "UpTools", "url": "https://www.uptools.in/" },
        "url": "https://www.uptools.in/plagiarism-checker/",
        "featureList": ["Originality percentage", "Risky sentence detection", "Paraphrasing", "Keyword density"]
      },
      {
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://www.uptools.in/" },
          { "@type": "ListItem", "position": 2, "name": "AI Plagiarism Checker", "item": "https://www.uptools.in/plagiarism-checker/" }
        ]
      },
      {
        "@type": "FAQPage",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "Do you store or share my text?",
            "acceptedAnswer": { "@type": "Answer", "text": "No. Text is sent to our Cloudflare Worker which forwards to the selected AI provider using a server-side key. We do not store your text." }
          },
          {
            "@type": "Question",
            "name": "Is this equivalent to Turnitin/Copyscape?",
            "acceptedAnswer": { "@type": "Answer", "text": "This is an AI-based originality estimator. It does not crawl or compare with proprietary academic databases. Use it for guidance, not formal academic submission checks." }
          },
          {
            "@type": "Question",
            "name": "Which AI models are available?",
            "acceptedAnswer": { "@type": "Answer", "text": "Perplexity Sonar (sonar, sonar-pro, sonar-reasoning), Google Gemini 2.5 (Flash/Pro), and Groq models (Llama/Gemma/Mixtral)." }
          }
        ]
      }
    ]
  }
  </script>

  <style>
    html,
    body {
      /* System stack only (removed custom font to fix 404 + avoid FOIT/CLS) */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.5;
      text-rendering: optimizeLegibility;
    }

    /* Keep header height stable */
    header.site .header-inner {
      min-height: 56px;
    }

    main.tool {
      max-width: 1200px;
      margin-inline: auto;
      padding: 12px var(--container-px, 12px);
    }

    :root {
      --panel-h: clamp(520px, 72dvh, 820px);
      --gap: 14px;
    }

    /* Two columns -> one column */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items: stretch;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* Panels: isolate layout so inner changes don't shift outer */
    .panel {
      display: flex;
      flex-direction: column;
      height: var(--panel-h);
      min-height: 480px;
      overflow: hidden;
      position: relative;
      z-index: 0;
      contain: layout paint;
      /* key for CLS */
    }

    @media (max-width: 780px) {
      .panel {
        height: auto;
        min-height: 0;
        overflow: visible;
      }
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
    }

    .panel-body {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      padding: 10px 12px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .row {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 720px) {
      .row {
        grid-template-columns: 1fr;
      }
    }

    /* Reserve space for taskOptions to avoid first-paint shift */
    #taskOptions {
      min-height: 44px;
      display: grid;
      align-items: center;
    }

    /* Input / Output areas */
    textarea.input {
      width: 100%;
      height: auto;
      min-height: 160px;
      max-height: min(34dvh, 420px);
      resize: vertical;
      padding: 10px 12px;
      line-height: 1.45;
      border-radius: 12px;
    }

    @media (max-width:480px) {
      textarea.input {
        max-height: 28dvh;
        min-height: 140px;
      }
    }

    pre.output {
      width: 100%;
      min-height: clamp(220px, 26dvh, 360px);
      max-height: min(44dvh, 520px);
      height: auto;
      margin: 0;
      padding: 12px 14px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
      border-radius: 12px;
      background: #121826;
      border: 1px solid #212a3a;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      line-height: 1.55;
    }

    pre.output:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    /* Status gets a fixed line box so showing text doesn't move layout */
    #status.tiny {
      min-height: 1.2em;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(120px, 1fr));
      gap: 10px;
    }

    @media (max-width:880px) {
      .kpis {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width:460px) {
      .kpis {
        grid-template-columns: 1fr;
      }
    }

    .kpi {
      padding: 10px;
      border-radius: 10px;
      background: #0a1224;
      border: 1px solid var(--border);
      box-shadow: var(--glow-soft);
    }

    .kpi b {
      font-size: 18px;
      display: block;
    }

    .tiny {
      font-size: 12px;
      opacity: .85;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .danger {
      background: transparent;
      color: #ffb4b4;
      border: 1px solid color-mix(in oklab, red 60%, #223);
    }

    /* Video section */
    .video-card {
      position: relative;
      z-index: 1;
    }

    .yt-wrap {
      width: 100%;
      max-width: 820px;
      aspect-ratio: 16/9;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #080d18;
      margin-top: 8px;
      position: relative;
      contain: layout paint;
    }

    .yt-thumb {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    .yt-play {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      cursor: pointer;
      background: linear-gradient(0deg, rgba(0, 0, 0, .35), rgba(0, 0, 0, .35));
    }

    .yt-play span {
      width: 68px;
      height: 48px;
      border-radius: 12px;
      background: rgba(0, 0, 0, .6);
      display: grid;
      place-items: center;
    }

    .yt-play svg {
      width: 28px;
      height: 28px;
      fill: #fff;
    }

    /* Tips / Related */
    .tips-related {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr 1fr;
      align-items: start;
    }

    .tips-related .list {
      margin: 0;
    }

    @media (max-width:720px) {
      .tips-related {
        grid-template-columns: 1fr;
      }
    }

    /* Ensure later sections never get covered */
    section.card,
    section.spaced,
    .site-footer {
      position: relative;
      z-index: 0;
    }

    /* Focus styles */
    a:focus,
    button:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6216304334889617"
    crossorigin="anonymous"></script>
  <!-- small fixed -->
  <ins class="adsbygoogle" style="display:inline-block;width:500px;height:50px" data-ad-client="ca-pub-6216304334889617"
    data-ad-slot="9810172647"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <header class="site" role="banner">
    <div class="header-inner">
      <a class="brand" href="/" aria-label="UpTools Home">
        <img src="/assets/logo/uptools-logo.svg" alt="UpTools logo" width="28" height="28" fetchpriority="high">
        <b>UpTools</b>
      </a>
      <nav class="nav-links" aria-label="Primary navigation">
        <a href="/#tools">Tools</a>
        <a href="/ai-writer/">AI Writer</a>
        <a href="/word-counter/">Word Counter</a>
        <a aria-current="page" href="/plagiarism-checker/">Plagiarism</a>
      </nav>
    </div>
  </header>

  <main class="tool container" id="top">
    <section class="card hero" aria-labelledby="title">
      <div>
        <h1 id="title">🧠🔎 AI Plagiarism Checker &amp; Paraphraser</h1>
        <p class="note" style="margin:0">
          Check estimated originality %, highlight risky lines, and paraphrase instantly to remove plagiarism.
          Choose Perplexity, Google Gemini 2.5, or Groq.
        </p>
        <div class="chips" style="margin-top:8px">
          <span class="pill">⚡ Streams live</span>
          <span class="pill">🔒 No browser API key</span>
          <a class="chip" href="/sitemap.xml">Sitemap</a>
          <a class="chip" href="/about/"><span class="card-badge" aria-hidden="true">ABT</span> <span
              class="sr-only">About page</span>About</a>
          <a class="chip" href="/contact/"><span class="card-badge" aria-hidden="true">CT</span> <span
              class="sr-only">Contact page</span>Contact</a>
        </div>
      </div>
    </section>

    <section class="grid" aria-label="Workspace">
      <article class="panel card" aria-labelledby="input-title">
        <div class="panel-head">
          <h2 id="input-title" class="h4">Your Text</h2>
          <div class="toolbar" role="group" aria-label="Input controls">
            <label class="inline tiny"><span>Characters:</span> <output id="charCount">0</output></label>
            <label class="inline tiny"><span>Words:</span> <output id="wordCount">0</output></label>
            <button id="pasteBtn" class="btn sm" type="button" title="Paste from clipboard">Paste</button>
            <label class="btn sm" title="Import .txt or .md">
              Import <input id="fileIn" type="file" accept=".txt,.md" hidden aria-label="Import .txt or .md">
            </label>
            <button id="clearBtn" class="btn sm secondary" type="button" title="Clear input">Clear</button>
          </div>
        </div>

        <div class="panel-body">
          <div class="row">
            <label class="inline" style="gap:6px">
              <span class="tiny">Task</span>
              <select id="task" class="select" style="width:210px" aria-label="Select task">
                <option value="originality" selected>Check Originality (AI)</option>
                <option value="paraphrase">Paraphrase / Rewrite</option>
                <option value="keywords">Keyword Density</option>
              </select>
            </label>

            <!-- Pre-render default task options to avoid first-paint shift -->
            <div class="inline" id="taskOptions" aria-live="polite">
              <label class="inline"><span class="tiny">Depth</span>
                <select id="optDepth" class="select" aria-label="Originality depth">
                  <option value="fast">Fast</option>
                  <option value="balanced" selected>Balanced</option>
                  <option value="thorough">Thorough</option>
                </select>
              </label>
              <label class="inline"><span class="tiny">Return</span>
                <select id="optFormat" class="select" aria-label="Originality return format">
                  <option value="bullets" selected>Bullets + score</option>
                  <option value="table">Table of risky lines</option>
                  <option value="json">JSON (score, notes)</option>
                </select>
              </label>
            </div>
          </div>

          <textarea id="input" class="input" placeholder="Paste or type your text here…" spellcheck="true"
            aria-label="Input text"></textarea>

          <div class="toolbar" role="group" aria-label="Model selection">
            <button id="runBtn" class="btn" type="button">Run ▶</button>
            <button id="stopBtn" class="btn danger sm" type="button" disabled>Stop</button>

            <label class="inline" title="Inference provider">
              <span class="tiny">Provider</span>
              <select id="provider" class="select" style="width:160px" aria-label="Inference provider">
                <option value="perplexity" selected>Perplexity</option>
                <option value="google">Google (Gemini)</option>
                <option value="groq">Groq</option>
              </select>
            </label>

            <label class="inline" title="Model">
              <span class="tiny">Model</span>
              <!-- Pre-fill default models to avoid JS-population shift -->
              <select id="modelSel" class="select" style="width:230px" aria-label="Model">
                <option value="sonar" selected>sonar</option>
                <option value="sonar-pro">sonar-pro</option>
                <option value="sonar-reasoning">sonar-reasoning</option>
              </select>
            </label>

            <button id="saveCfg" class="btn sm secondary" type="button" title="Save provider &amp; model">Save</button>
          </div>
        </div>
      </article>

      <article class="panel card" aria-labelledby="output-title">
        <div class="panel-head">
          <h2 id="output-title" class="h4">Results</h2>
          <div class="toolbar" role="group" aria-label="Output actions">
            <button id="copyBtn" class="btn sm" type="button">Copy</button>
            <button id="downloadBtn" class="btn sm" type="button">Download .txt</button>
            <button id="permBtn" class="btn sm secondary" type="button"
              title="Create a shareable link with your settings">Permalink</button>
          </div>
        </div>

        <div class="panel-body">
          <div class="kpis" id="kpis" aria-live="polite">
            <div class="kpi"><span class="tiny">Estimated Originality</span><b id="kpiOriginality">-</b></div>
            <div class="kpi"><span class="tiny">Sentence Variety</span><b id="kpiVariety">-</b></div>
            <div class="kpi"><span class="tiny">Flesch Reading Ease</span><b id="kpiFlesch">-</b></div>
            <div class="kpi"><span class="tiny">Repeated 4-grams</span><b id="kpiNgram">-</b></div>
          </div>
          <div class="tiny" id="status" aria-live="polite" style="margin-top:2px"></div>
          <pre id="output" class="output" tabindex="0" aria-label="AI output"></pre>

          <div class="tips-related" role="region" aria-label="Tips and related tools">
            <div>
              <h3 class="h5">Tips</h3>
              <ul class="list compact">
                <li><b>Originality:</b> We combine an AI estimate with local heuristics (n-gram repetition, sentence
                  variety). Use as guidance.</li>
                <li><b>Paraphrase:</b> Choose tone and constraints for safer rewrites.</li>
                <li><b>Academic use:</b> Always cite your sources. See <a
                    href="https://en.wikipedia.org/wiki/Plagiarism" target="_blank" rel="nofollow noopener">what is
                    plagiarism</a>.</li>
              </ul>
            </div>
            <div>
              <h3 class="h5">Related</h3>
              <ul class="list compact">
                <li><a href="/ai-writer/">AI Writer</a> - summarize, translate, SEO meta.</li>
                <li><a href="/word-counter/">Word Counter</a> - words, chars, reading time.</li>
                <li><a href="/resume-analyzer/">Resume Analyzer</a> - ATS score &amp; keywords.</li>
              </ul>
            </div>
          </div>
        </div>
      </article>
    </section>

    <section class="card spaced video-card" aria-labelledby="video-title">
      <h2 id="video-title" class="h5">How to Use the AI Plagiarism Checker (2 min)</h2>
      <div class="yt-wrap" role="group" aria-label="YouTube demo">
        <picture>
          <!-- Use vi_webp to avoid 404s on some videos -->
          <source type="image/webp" srcset="https://i.ytimg.com/vi_webp/Uk1pq8sb-eo/hqdefault.webp">
          <img class="yt-thumb" src="https://i.ytimg.com/vi/Uk1pq8sb-eo/hqdefault.jpg"
            alt="Video thumbnail: How to use AI Plagiarism Checker" loading="lazy" decoding="async" width="1280"
            height="720">
        </picture>
        <button class="yt-play" type="button" aria-label="Play video" data-yt="Uk1pq8sb-eo">
          <span aria-hidden="true">
            <svg viewBox="0 0 68 48" width="68" height="48" aria-hidden="true">
              <path
                d="M66.52 7.74a8 8 0 0 0-5.62-5.66C56.3 1 34 1 34 1s-22.3 0-26.9 1.08A8 8 0 0 0 1.48 7.74 83.3 83.3 0 0 0 0 24a83.3 83.3 0 0 0 1.48 16.26 8 8 0 0 0 5.62 5.66C11.7 47 34 47 34 47s22.3 0 26.9-1.08a8 8 0 0 0 5.62-5.66A83.3 83.3 0 0 0 68 24a83.3 83.3 0 0 0-1.48-16.26zM27 34V14l18 10z" />
            </svg>
          </span>
        </button>
        <noscript>
          <iframe width="100%" height="100%" src="https://www.youtube.com/embed/Uk1pq8sb-eo?si=sL6U-5pxYUHEjvux"
            title="YouTube video player" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"></iframe>
        </noscript>
      </div>
      <p class="tiny" style="margin-top:8px">Video covers originality %, risky line highlights, paraphrasing with tone,
        and generating permalinks.</p>
    </section>

    <section class="spaced" aria-labelledby="related">
      <h2 id="related" class="h5">More from UpTools</h2>
      <div class="grid" style="grid-template-columns: repeat(4,1fr);">
        <a class="card tool-link accent-indigo" href="/text-case-converter/"><span class="ico"
            aria-hidden="true">🔤</span><span><b>Text Case Converter</b><br><span class="note">Upper/lower/title
              case</span></span></a>
        <a class="card tool-link accent-emerald" href="/json-formatter/"><span class="ico"
            aria-hidden="true">🧩</span><span><b>JSON Formatter</b><br><span class="note">Prettify &amp;
              validate</span></span></a>
        <a class="card tool-link accent-cyan" href="/image-converter/"><span class="ico"
            aria-hidden="true">🖼️</span><span><b>Image Converter</b><br><span class="note">Resize &amp;
              format</span></span></a>
        <a class="card tool-link accent-violet" href="/qr-generator/"><span class="ico"
            aria-hidden="true">🔳</span><span><b>QR Generator</b><br><span class="note">Create QR
              codes</span></span></a>
      </div>
    </section>

    <footer class="site-footer">
      <nav class="nav-links" aria-label="Footer">
        <a href="/about/"><span class="card-badge" aria-hidden="true">ABT</span> About</a>
        <a href="/contact/"><span class="card-badge" aria-hidden="true">CT</span> Contact</a>
        <a href="/privacy/"><span class="card-badge" aria-hidden="true">PP</span> Privacy</a>
      </nav>
      <p class="tiny">© <span id="y"></span> UpTools . <a href="https://creativecommons.org/licenses/" target="_blank"
          rel="nofollow noopener">Creative Commons</a></p>
    </footer>
  </main>

  <script type="module">
    import { $, $$, debounce, persist, read } from '/scripts/utils.js';

    const byId = (id) => document.getElementById(id);
    const input = byId('input');
    const status = byId('status');
    const output = byId('output');
    const pasteBtn = byId('pasteBtn');
    const clearBtn = byId('clearBtn');
    const fileIn = byId('fileIn');
    const copyBtn = byId('copyBtn');
    const downloadBtn = byId('downloadBtn');
    const permBtn = byId('permBtn');
    const saveCfg = byId('saveCfg');
    const taskSel = byId('task');
    const taskOptions = byId('taskOptions');
    const charCount = byId('charCount');
    const wordCount = byId('wordCount');
    const kpiOriginality = byId('kpiOriginality');
    const kpiVariety = byId('kpiVariety');
    const kpiFlesch = byId('kpiFlesch');
    const kpiNgram = byId('kpiNgram');
    const providerSel = byId('provider');
    const modelSel = byId('modelSel');
    const runBtn = byId('runBtn');
    const stopBtn = byId('stopBtn');

    // Provider & Models
    const PROVIDER_MODELS = {
      perplexity: [
        { id: 'sonar', label: 'sonar' },
        { id: 'sonar-pro', label: 'sonar-pro' },
        { id: 'sonar-reasoning', label: 'sonar-reasoning' }
      ],
      google: [
        { id: 'gemini-2.5-flash', label: 'gemini-2.5-flash' },
        { id: 'gemini-2.5-pro', label: 'gemini-2.5-pro' }
      ],
      groq: [
        { id: 'llama-3.1-8b-instant', label: 'llama-3.1-8b-instant' },
        { id: 'llama-3.1-70b-versatile', label: 'llama-3.1-70b-versatile' },
        { id: 'mixtral-8x7b-32768', label: 'mixtral-8x7b-32768' },
        { id: 'gemma2-9b-it', label: 'gemma2-9b-it' }
      ]
    };
    const GOOGLE_MODEL_FALLBACKS = {
      'gemini-2.5-flash': ['gemini-2.0-flash', 'gemini-1.5-flash', 'gemini-1.5-flash-001'],
      'gemini-2.5-pro': ['gemini-2.0-pro', 'gemini-1.5-pro', 'gemini-1.5-pro-001']
    };
    const CFG_KEY = 'plagiarism:cfg';
    const cfg = Object.assign({ provider: 'perplexity', model: 'sonar' }, read(CFG_KEY, {}));

    // Initialize provider / model without causing layout changes
    providerSel.value = cfg.provider || 'perplexity';
    (function populateModelsInitial() {
      const prov = providerSel.value;
      const models = PROVIDER_MODELS[prov] || [];
      const desired = cfg.model || (models[0]?.id || 'sonar');
      const needs = ![...modelSel.options].map(o => o.value).every((v, i) => models[i]?.id === v);
      if (needs) {
        modelSel.innerHTML = '';
        for (const m of models) {
          const opt = document.createElement('option');
          opt.value = m.id; opt.textContent = m.label;
          modelSel.appendChild(opt);
        }
      }
      modelSel.value = desired;
    })();

    function populateModels() {
      const prov = providerSel.value || 'perplexity';
      const models = PROVIDER_MODELS[prov] || [];
      modelSel.innerHTML = '';
      for (const m of models) {
        const opt = document.createElement('option');
        opt.value = m.id; opt.textContent = m.label;
        modelSel.appendChild(opt);
      }
      const ok = models.some(m => m.id === cfg.model);
      modelSel.value = ok ? cfg.model : (models[0]?.id || '');
    }

    saveCfg.addEventListener('click', () => {
      persist(CFG_KEY, { provider: providerSel.value, model: modelSel.value });
      toast('Settings saved');
    });
    providerSel.addEventListener('change', () => {
      cfg.provider = providerSel.value;
      populateModels();
    });

    // Counts
    function counts(text) {
      const words = (text.trim().match(/\b[\w''-]+\b/gu) || []).length;
      return { chars: text.length, words };
    }
    function updateCounts() {
      const { chars, words } = counts(input.value);
      charCount.textContent = chars.toLocaleString();
      wordCount.textContent = words.toLocaleString();
    }
    input.addEventListener('input', debounce(updateCounts, 80));
    updateCounts();

    // Paste / Clear / Import
    pasteBtn.addEventListener('click', async () => {
      try { input.value = await navigator.clipboard.readText(); updateCounts(); input.focus(); }
      catch { toast('Clipboard blocked by browser'); }
    });
    clearBtn.addEventListener('click', () => {
      input.value = ''; updateCounts(); input.focus(); resetKPIs(); output.textContent = ''; status.textContent = '';
    });
    fileIn.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const text = await f.text(); input.value = text; updateCounts();
    });

    // Task options (switching away from default)
    taskSel.addEventListener('change', () => {
      const t = taskSel.value;
      if (t === 'originality') { return; }
      if (t === 'paraphrase') {
        taskOptions.innerHTML = `
          <label class="inline"><span class="tiny">Tone</span>
            <select id="optTone" class="select" aria-label="Paraphrase tone">
              <option>Neutral</option><option>Friendly</option><option>Formal</option>
              <option>Academic</option><option>Simple</option><option>Sales</option>
            </select>
          </label>
          <label class="inline"><span class="tiny">Constraints</span>
            <input id="optRules" class="input" placeholder="e.g. shorter, active voice, vary sentence structure" style="width:260px" aria-label="Paraphrase constraints">
          </label>`;
      } else if (t === 'keywords') {
        taskOptions.innerHTML = `
          <label class="inline"><span class="tiny">Top N</span>
            <input id="optTopN" type="number" class="input" value="20" min="5" max="60" style="width:90px" aria-label="Top N keywords">
          </label>
          <label class="inline"><span class="tiny">Include phrases</span>
            <select id="optPhrases" class="select" aria-label="Include phrases"><option>Yes</option><option>No</option></select>
          </label>`;
      }
    });

    // Heuristics (local)
    function sentences(text) { return (text.trim().match(/[^.!?]+[.!?]*/g) || []).map(s => s.trim()).filter(Boolean); }
    function avg(a) { return a.length ? a.reduce((x, y) => x + y, 0) / a.length : 0; }
    function stddev(a) { if (!a.length) return 0; const m = avg(a); return Math.sqrt(avg(a.map(x => (x - m) * (x - m)))); }
    function fleschReadingEase(text) {
      const words = (text.match(/\b[a-zA-Z''-]+\b/g) || []);
      const syllables = words.reduce((s, w) => s + ((w.toLowerCase().match(/[aeiouy]+/g) || []).length || 1), 0);
      const sents = sentences(text).length || 1;
      const W = Math.max(words.length, 1), S = Math.max(sents, 1), SYL = Math.max(syllables, 1);
      return Math.max(0, Math.min(100, 206.835 - 1.015 * (W / S) - 84.6 * (SYL / W)));
    }
    function ngramRepeats(text, n = 4) {
      const tokens = (text.toLowerCase().match(/\b[\w''-]+\b/g) || []);
      const grams = new Map(); let repeats = 0;
      for (let i = 0; i <= tokens.length - n; i++) { const g = tokens.slice(i, i + n).join(' '); grams.set(g, (grams.get(g) || 0) + 1); }
      grams.forEach(c => { if (c > 1) repeats += (c - 1); });
      return repeats;
    }
    function sentenceVariety(text) { const lens = sentences(text).map(s => s.split(/\s+/).filter(Boolean).length); return stddev(lens); }
    function heuristicOriginality(text) {
      if (!text || text.trim().length < 60) return 100;
      const fre = fleschReadingEase(text); const rep4 = ngramRepeats(text, 4); const varS = sentenceVariety(text);
      let score = 92 - Math.min(40, rep4 * 2.5) + Math.min(6, varS * 0.6) + Math.min(6, (fre - 50) / 10);
      return Math.max(0, Math.min(100, Math.round(score)));
    }
    function updateKPIs(text) {
      kpiOriginality.textContent = heuristicOriginality(text) + '%';
      kpiVariety.textContent = sentenceVariety(text).toFixed(1);
      kpiFlesch.textContent = fleschReadingEase(text).toFixed(0);
      kpiNgram.textContent = ngramRepeats(text, 4).toString();
    }
    function resetKPIs() { kpiOriginality.textContent = '-'; kpiVariety.textContent = '-'; kpiFlesch.textContent = '-'; kpiNgram.textContent = '-'; }
    input.addEventListener('input', debounce(() => updateKPIs(input.value), 100));

    // Prompt builder
    function buildPrompt(task, text) {
      const v = id => document.getElementById(id)?.value;
      if (task === 'originality') {
        return [
          "You are an academic integrity assistant.",
          "Analyze the user's text for potential plagiarism risk WITHOUT using web search.",
          "Return: a short originality percentage estimate, and a concise list of risky lines/phrases with reasons (cliché, overused phrasing, unlikely author voice, formulaic structure, etc.).",
          `Depth: ${v('optDepth') || 'balanced'}. Format: ${v('optFormat') || 'bullets'}.`,
          "Do not invent sources or URLs. Keep it actionable.",
          "\n---\n", text
        ].join('\n');
      }
      if (task === 'paraphrase') {
        return [
          `Paraphrase the text to improve originality while preserving meaning.`,
          `Tone: ${v('optTone') || 'Neutral'}. Constraints: ${v('optRules') || 'vary sentence structure; avoid clichés; active voice; keep citations if present.'}`,
          "Return only the rewritten text.",
          "\n---\n", text
        ].join('\n');
      }
      return [
        `Extract top ${(v('optTopN') || 20)} keywords from the text${(v('optPhrases') || 'Yes') === 'Yes' ? ' including keyphrases' : ''}.`,
        "Return as a comma-separated list only.", "\n---\n", text
      ].join('\n');
    }

    // Streaming via Worker proxy (/ai)
    let aborter = null;
    async function streamChat({ provider, model, prompt }) {
      const attempt = async (prov, mdl) => {
        const res = await fetch('/ai', {
          method: 'POST',
          signal: (aborter = new AbortController()).signal,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            provider: prov, model: mdl, stream: true, temperature: 0.3,
            messages: [
              { role: 'system', content: 'You are a concise, careful assistant.' },
              { role: 'user', content: prompt }
            ]
          })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const reader = res.body.getReader(); const dec = new TextDecoder(); let acc = '';

        const append = (txt) => { if (!txt) return; acc += txt; output.append(document.createTextNode(txt)); output.scrollTop = output.scrollHeight; };

        for (; ;) {
          const { value, done } = await reader.read(); if (done) break;
          const chunk = dec.decode(value, { stream: true });
          for (const raw of chunk.split('\n')) {
            const line = raw.trim(); if (!line || !line.startsWith('data:')) continue;
            const payload = line.slice(5).trim(); if (payload === '[DONE]') { aborter = null; return acc; }
            try {
              const json = JSON.parse(payload);
              if (json.choices?.[0]?.delta?.content != null) { append(json.choices[0].delta.content); continue; }
              if (json.candidates?.length) {
                const c = json.candidates[0], d = c.delta?.parts || [], p = c.content?.parts || [];
                if (d.length) { append(d.map(x => x.text || '').join('')); continue; }
                if (p.length) { append(p.map(x => x.text || '').join('')); continue; }
                if (c.content?.text) { append(c.content.text); continue; }
              }
              if (typeof json.text === 'string') { append(json.text); continue; }
              if (json.message?.content) { append(json.message.content); continue; }
              if (json.error?.message) throw new Error(json.error.message);
            } catch {
              if (payload && payload !== '[DONE]') append(payload + "\n");
            }
          }
        }
        aborter = null; return acc;
      };

      output.textContent = ''; status.textContent = 'Running…'; stopBtn.disabled = false;

      try {
        try { return await attempt(provider, model); }
        catch (e) {
          if (provider === 'google') {
            for (const alt of (GOOGLE_MODEL_FALLBACKS[model] || [])) {
              try {
                status.textContent = `Retrying with ${alt}…`;
                const result = await attempt('google', alt);
                persist(CFG_KEY, { provider: 'google', model: alt }); modelSel.value = alt;
                return result;
              } catch { }
            }
          }
          throw e;
        }
      } finally { stopBtn.disabled = true; }
    }

    byId('stopBtn').addEventListener('click', () => {
      if (aborter) { aborter.abort(); aborter = null; stopBtn.disabled = true; status.textContent = 'Stopped.'; }
    });

    byId('runBtn').addEventListener('click', async () => {
      const text = input.value.trim();
      if (!text) { toast('Enter some text first'); input.focus(); return; }
      updateKPIs(text);

      const provider = providerSel.value || 'perplexity';
      const model = modelSel.value || (PROVIDER_MODELS[provider]?.[0]?.id ?? '');
      if (!model) { toast('Pick a model'); return; }

      const task = taskSel.value; output.textContent = ''; stopBtn.disabled = false; status.textContent = 'Running…';
      try {
        const prompt = buildPrompt(task, text);
        await streamChat({ provider, model, prompt });
        status.textContent = 'Done.';
      } catch (e) {
        status.textContent = (e?.message || 'Error') + ' - check provider/model or quotas.';
        toast('Request failed.');
      } finally { stopBtn.disabled = true; }
    });

    // Copy / Download / Permalink
    byId('copyBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(output.textContent || ''); toast('Copied'); }
      catch { toast('Copy blocked by browser'); }
    });
    byId('downloadBtn').addEventListener('click', () => {
      const blob = new Blob([output.textContent || ''], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ai-result.txt'; a.click();
      URL.revokeObjectURL(a.href);
    });
    byId('permBtn').addEventListener('click', async () => {
      const o = { t: taskSel.value, p: providerSel.value, m: modelSel.value };
      const url = new URL(location.href); url.hash = encodeURIComponent(btoa(JSON.stringify(o)));
      try { await navigator.clipboard.writeText(url.toString()); toast('Permalink copied'); }
      catch { toast('Permalink ready (check address bar)'); history.replaceState({}, '', url); }
    });

    function toast(msg) { status.textContent = msg; setTimeout(() => { if (status.textContent === msg) status.textContent = ''; }, 1800); }

    // Init KPIs and Year
    (function init() { document.getElementById('y').textContent = new Date().getFullYear(); resetKPIs(); })();
  </script>

  <!-- Lazy YouTube loader (container pre-sized, so no CLS) -->
  <script defer>
    (function () {
      const btn = document.querySelector('.yt-play'); const wrap = document.querySelector('.yt-wrap');
      if (!btn || !wrap) return;
      const loadIframe = () => {
        if (wrap.dataset.loaded) return;
        const id = btn.getAttribute('data-yt');
        const iframe = document.createElement('iframe');
        iframe.width = '100%'; iframe.height = '100%';
        iframe.src = 'https://www.youtube.com/embed/' + id + '?autoplay=1&rel=0';
        iframe.title = 'YouTube video player'; iframe.loading = 'lazy';
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
        iframe.setAttribute('allowfullscreen', '');
        wrap.innerHTML = ''; wrap.appendChild(iframe); wrap.dataset.loaded = '1';
      };
      btn.addEventListener('click', loadIframe, { passive: true });
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) { loadIframe(); io.disconnect(); } });
        }, { rootMargin: '200px' });
        io.observe(wrap);
      }
    })();
  </script>
</body>

</html>
