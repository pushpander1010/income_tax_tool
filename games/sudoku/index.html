<!doctype html>
<html lang="en">
<head>
  <!-- Core Meta -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sudoku – Free Online Game (Mobile & Desktop) | UpTools</title>
  <meta name="description" content="Play a fast, mobile-friendly Sudoku game by UpTools. Easy, Medium, Hard & Expert modes, notes, hints, timer, pause, undo, and share-a-challenge. Saves progress & best times in cookies. No signup." />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />
  <meta name="theme-color" content="#0b1020" />
  <meta name="keywords" content="sudoku, sudoku online, sudoku game, play sudoku, free sudoku, mobile sudoku, browser sudoku, puzzle game, uptools games" />

  <!-- Canonical & Icons -->
  <link rel="canonical" href="https://www.uptools.in/games/sudoku/" />
  <link rel="icon" type="image/svg+xml" href="/assets/logo/uptools.svg" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Sudoku – Free Online Game | UpTools" />
  <meta property="og:description" content="Fast, responsive Sudoku with hints, notes, timer & share-a-challenge. Saves progress in cookies. No signup." />
  <meta property="og:url" content="https://www.uptools.in/games/sudoku/" />
  <meta property="og:image" content="https://www.uptools.in/assets/og/udoku-og.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Sudoku – Free Online Game | UpTools" />
  <meta name="twitter:description" content="Fast, responsive Sudoku with hints, notes, timer & share-a-challenge. Saves progress in cookies. No signup." />
  <meta name="twitter:image" content="https://www.uptools.in/assets/og/udoku-og.jpg" />

  <!-- JSON-LD (Game) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"VideoGame",
    "name":"Sudoku",
    "applicationCategory":"Game",
    "gamePlatform":["Web"],
    "operatingSystem":"All",
    "url":"https://www.uptools.in/games/sudoku/",
    "image":"https://www.uptools.in/assets/og/udoku-og.jpg",
    "description":"A lightweight Sudoku you can play on mobile & desktop. Hints, notes, timer, pause, undo and share-a-challenge built-in.",
    "inLanguage":"en",
    "publisher":{"@type":"Organization","name":"UpTools"}
  }
  </script>

  <!-- Common CSS (project-wide) -->
  <link rel="stylesheet" href="/style.css" />

  <!-- Lightweight animated background + per-game overrides -->
  <style>
    :root{
      --bg-a:#0b1020;
      --bg-b:#101733;
      --accent:#64ffda;
      --accent-2:#8a7dff;
      --good:#2ecc71;
      --warn:#ff7675;
      --ink:#e6f1ff;
      --muted:#9aa7bd;
      --grid:#2a3352;
      --grid-bold:#3b4670;
      --cell:#121a34;
      --cell-hover:#182244;
      --cell-selected:#1f2a54;
      --cell-fixed:#0f1731;
      --btn:#1b2344;
      --btn-border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    /* Full-bleed app shell */
    html,body{height:100%;background:var(--bg-a);color:var(--ink);}
    body{margin:0;overflow:hidden;touch-action:manipulation;-webkit-tap-highlight-color:transparent;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
    .app{
      position:relative;min-height:100svh;display:grid;
      grid-template-rows:auto 1fr auto;isolation:isolate;
    }

    /* Subtle-but-noticeable animated gradient + floating shapes */
    .bg{
      position:fixed;inset:0;z-index:-1;overflow:hidden;
      background:
        radial-gradient(1200px 600px at var(--x,60%) var(--y,40%), rgba(100,255,218,.09), transparent 70%),
        radial-gradient(800px 500px at calc(100% - var(--x,60%)) calc(100% - var(--y,40%)), rgba(138,125,255,.10), transparent 70%),
        linear-gradient(180deg, var(--bg-b), var(--bg-a));
      transition:background-position .2s;
    }
    .bg .orb{position:absolute;inset:auto;width:220px;height:220px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(100,255,218,.18), rgba(100,255,218,0) 60%),
                 radial-gradient(circle at 70% 70%, rgba(138,125,255,.16), rgba(138,125,255,0) 60%);
      filter:blur(6px);opacity:.7;will-change:transform;animation:float 18s ease-in-out infinite;
      box-shadow:0 0 120px rgba(100,255,218,.12), inset 0 0 40px rgba(138,125,255,.12);
    }
    .bg .orb:nth-child(1){left:6%; top:18%; animation-delay:-2s;}
    .bg .orb:nth-child(2){right:8%; top:12%; animation-delay:-6s;}
    .bg .orb:nth-child(3){left:22%; bottom:10%; animation-delay:-10s;}
    .bg .orb:nth-child(4){right:20%; bottom:16%; animation-delay:-14s;}
    @keyframes float{
      0%,100%{transform:translate3d(0,0,0) rotate(0deg)}
      50%{transform:translate3d(0,-18px,0) rotate(2deg)}
    }

    /* Header + Back button */
    .topbar{
      display:flex;gap:.75rem;align-items:center;justify-content:space-between;
      padding:.8rem clamp(12px,3vw,24px); backdrop-filter:saturate(140%) blur(6px);
      background:linear-gradient(180deg, rgba(5,8,18,.75), rgba(5,8,18,.35));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:700;letter-spacing:.2px}
    .brand .dot{width:.65rem;height:.65rem;border-radius:50%;background:var(--accent)}
    .actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--btn-border);background:var(--btn);color:var(--ink);
      padding:.55rem .8rem;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);
      font-weight:600;font-size:.95rem;line-height:1;display:inline-flex;align-items:center;gap:.45rem;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent}
    .badge{font-size:.8rem;color:var(--muted)}

    /* Layout: grid and side controls */
    .main{
      display:grid;place-items:center;padding:clamp(8px,2vw,20px);
    }
    .board-wrap{
      width:min(94vw, 560px);
      display:grid;grid-template-rows:auto 1fr auto;gap:14px;
    }
    .hud{
      display:flex;justify-content:space-between;align-items:center;gap:.5rem;
      background:rgba(15,23,49,.6);border:1px solid rgba(255,255,255,.06);
      padding:.6rem .8rem;border-radius:16px;box-shadow:var(--shadow);
    }
    .hud .group{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .timer{font-variant-numeric:tabular-nums;letter-spacing:.5px}
    .difficulty{font-weight:700}

    .board{
      aspect-ratio:1/1;background:var(--cell);border-radius:18px;padding:8px;
      display:grid;grid-template-columns:repeat(9,1fr);grid-template-rows:repeat(9,1fr);
      gap:2px;border:2px solid var(--grid-bold);box-shadow:var(--shadow);
      user-select:none;
    }
    .cell{
      background:#0d142b;border:1px solid var(--grid);display:grid;place-items:center;
      font-weight:700;font-size:clamp(16px, 3.2vw, 24px);border-radius:8px;position:relative;
      transition:background .15s,border-color .15s,box-shadow .15s;
    }
    .cell:hover{background:var(--cell-hover)}
    .cell.fixed{background:var(--cell-fixed);color:#bcd8ff}
    .cell.selected{background:var(--cell-selected);box-shadow:0 0 0 2px rgba(100,255,218,.22) inset}
    .cell.same{background:#172044}
    .cell.conflict{border-color:rgba(255,119,119,.7)}
    .cell .notes{position:absolute;inset:4px;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:2px;opacity:.8}
    .cell .notes span{font-size:.55em;color:#9fb1d9;display:grid;place-items:center}
    .cell > input{
      all:unset;display:block;width:100%;height:100%;text-align:center;cursor:default;
    }

    /* Thick borders for 3x3 boxes */
    .cell[data-r="2"], .cell[data-r="5"]{border-bottom:2px solid var(--grid-bold)}
    .cell[data-r="3"], .cell[data-r="6"]{ /* next row starts bold top via previous row bottom */ }
    .cell[data-c="2"], .cell[data-c="5"]{border-right:2px solid var(--grid-bold)}

    /* Keypad */
    .keypad{
      display:grid;grid-template-columns:repeat(10,1fr);gap:8px;
    }
    .key{border-radius:12px;border:1px solid var(--btn-border);background:#0e1731;padding:.7rem 0;
      font-weight:800;text-align:center;cursor:pointer;box-shadow:var(--shadow);user-select:none}
    .key:hover{filter:brightness(1.1)}
    .key:active{transform:translateY(1px)}
    .key.action{font-weight:700}

    /* Start overlay */
    .overlay{
      position:fixed;inset:0;background:linear-gradient(180deg, rgba(6,10,24,.92), rgba(6,10,24,.7));
      display:grid;place-items:center;padding:16px;z-index:50;
    }
    .card{
      width:min(92vw,560px);background:rgba(15,23,49,.75);border:1px solid rgba(255,255,255,.08);
      border-radius:18px;padding:18px;box-shadow:var(--shadow);backdrop-filter:saturate(140%) blur(6px)
    }
    .card h1{margin:.2rem 0 0.6rem;font-size:clamp(22px,4.8vw,30px)}
    .card p{margin:.2rem 0 1rem;color:var(--muted)}
    .level-select{display:flex;flex-wrap:wrap;gap:.6rem}
    .level{flex:1 1 46%;min-width:120px}

    /* Footer links container for SEO/backlinks */
    footer{
      padding:16px;display:grid;gap:8px;justify-items:center;color:var(--muted);
      border-top:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg, rgba(5,8,18,.4), rgba(5,8,18,.2));
    }
    .links{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center}
    .links a{color:#b7c7ff;text-decoration:none;border-bottom:1px dashed rgba(183,199,255,.45)}
    .yt-embeds{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;width:100%;max-width:980px}
    .yt-embeds iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:12px}

    /* Small screens: keep grid large, controls wrap */
    @media (max-width:520px){
      .hud{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="bg" id="bg">
      <div class="orb"></div><div class="orb"></div><div class="orb"></div><div class="orb"></div>
    </div>

    <!-- Top bar -->
    <header class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>UpTools • Sudoku</span>
        <span class="badge" id="saveBadge" title="Saves in cookies">auto-save</span>
      </div>
      <div class="actions">
        <button class="btn secondary" id="backBtn" aria-label="Go back">← Back</button>
        <button class="btn" id="pauseBtn" aria-label="Pause">⏸ Pause</button>
      </div>
    </header>

    <!-- Main -->
    <main class="main">
      <div class="board-wrap">
        <div class="hud">
          <div class="group">
            <span class="difficulty" id="diffLabel">—</span>
            <span class="badge">Best: <strong id="bestTime">—</strong></span>
          </div>
          <div class="group">
            <span class="timer" id="timer">00:00</span>
            <button class="btn" id="newBtn">New</button>
            <button class="btn" id="hintBtn">Hint</button>
            <button class="btn" id="notesBtn" aria-pressed="false">Notes: Off</button>
            <button class="btn" id="undoBtn">Undo</button>
            <button class="btn" id="checkBtn">Check</button>
            <button class="btn" id="shareBtn">Challenge</button>
          </div>
        </div>

        <div class="board" id="board" role="grid" aria-label="Sudoku board">
          <!-- cells injected by JS -->
        </div>

        <div class="keypad" id="keypad" aria-label="Number keypad">
          <!-- 1..9 -->
          <div class="key" data-k="1">1</div>
          <div class="key" data-k="2">2</div>
          <div class="key" data-k="3">3</div>
          <div class="key" data-k="4">4</div>
          <div class="key" data-k="5">5</div>
          <div class="key" data-k="6">6</div>
          <div class="key" data-k="7">7</div>
          <div class="key" data-k="8">8</div>
          <div class="key" data-k="9">9</div>
          <div class="key action" data-k="0">⌫</div>
        </div>
      </div>
    </main>

    <!-- Footer: SEO links + YouTube embeds -->
    <footer>
      <div class="links" id="seo-links">
        <a href="https://www.uptools.in/games/" rel="noopener nofollow">More Games</a>
        <a href="https://www.uptools.in/games/snake/" rel="noopener">Snake</a>
        <a href="https://www.uptools.in/games/2048/" rel="noopener">2048</a>
        <a href="https://www.uptools.in/tools/json-formatter/" rel="noopener">JSON Formatter</a>
        <a href="https://www.uptools.in/tools/emi-calculator/" rel="noopener">EMI Calculator</a>
      </div>
      <div class="yt-embeds">
        <!-- Relevant tutorial videos (external, helps SEO/engagement) -->
        <iframe loading="lazy" src="https://www.youtube.com/embed/8zRXsqn6dZw" title="How to Solve Sudoku for Beginners"></iframe>
        <iframe loading="lazy" src="https://www.youtube.com/embed/C5g8Sgrs4u8" title="Sudoku Strategies & Tips"></iframe>
      </div>
      <small>© UpTools • Fast, privacy-first tools & games.</small>
    </footer>
  </div>

  <!-- Common JS utilities -->
  <script src="/utils.js" defer></script>

  <!-- Game Logic (inline) -->
  <script>
  (function(){
    "use strict";

    /* ========= Helpers (prefer common utils if present) ========= */
    const Utils = window.Utils || {};
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const on = (el,ev,fn,opt)=>el.addEventListener(ev,fn,opt);
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const fmtTime = secs=>{
      if(Utils.formatTime) return Utils.formatTime(secs);
      const m = Math.floor(secs/60).toString().padStart(2,'0');
      const s = Math.floor(secs%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    };
    const copyToClipboard = async (text)=>{
      if(Utils.copyToClipboard) return Utils.copyToClipboard(text);
      try{ await navigator.clipboard.writeText(text); return true; }catch{ return false; }
    };

    // Cookies (fallback if utils absent)
    function setCookie(name, value, days=365){
      const d = new Date(); d.setTime(d.getTime()+days*864e5);
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
    }
    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()[\]\\/+^])/g,'\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    /* ========= Background gentle parallax ========= */
    const bg = qs('#bg');
    let rafId = 0;
    function trackPointer(e){
      const r = document.body.getBoundingClientRect();
      const x = (e.clientX ?? (e.touches?.[0].clientX || r.width*0.6));
      const y = (e.clientY ?? (e.touches?.[0].clientY || r.height*0.4));
      bg.style.setProperty('--x', (x/r.width*100).toFixed(2)+'%');
      bg.style.setProperty('--y', (y/r.height*100).toFixed(2)+'%');
    }
    on(window,'pointermove',trackPointer,{passive:true});
    on(window,'touchmove',trackPointer,{passive:true});

    /* ========= Sudoku Core ========= */
    const SIZE=9, BOX=3;
    let solution = [];    // 81 array
    let puzzle = [];      // 81 array (0 for empty)
    let notes = Array(81).fill(0).map(()=>new Set());
    let fixed = new Set();
    let selected = -1;
    let timer = {startAt:0,elapsed:0,id:0,paused:true};
    let historyStack = [];
    let difficulty = 'Easy';
    const DIFF_MAP = { Easy:36, Medium:32, Hard:28, Expert:24 }; // givens
    const URL = new URL(location.href);
    const seedFromUrl = URL.searchParams.get('seed');
    const diffFromUrl = URL.searchParams.get('diff');

    const boardEl = qs('#board');
    const timerEl = qs('#timer');
    const diffEl = qs('#diffLabel');
    const bestEl = qs('#bestTime');
    const pauseBtn = qs('#pauseBtn');
    const notesBtn = qs('#notesBtn');
    const hintBtn = qs('#hintBtn');
    const undoBtn = qs('#undoBtn');
    const newBtn = qs('#newBtn');
    const checkBtn = qs('#checkBtn');
    const shareBtn = qs('#shareBtn');
    const backBtn = qs('#backBtn');

    let notesMode = false;

    function idx(r,c){return r*SIZE+c}
    function rc(i){return [Math.floor(i/SIZE), i%SIZE]}

    // Build DOM cells once
    function buildBoard(){
      boardEl.innerHTML = '';
      for(let r=0;r<9;r++){
        for(let c=0;c<9;c++){
          const i = idx(r,c);
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.r = r%3===2 ? '2' : (r%3===0 && r!==0 ? '3' : '');
          cell.dataset.c = c%3===2 ? '2' : (c%3===0 && c!==0 ? '3' : '');
          cell.setAttribute('role','gridcell');
          cell.setAttribute('tabindex','0');
          cell.dataset.i=i;

          const input = document.createElement('input');
          input.inputMode = 'numeric';
          input.setAttribute('aria-label', `Row ${r+1} Column ${c+1}`);
          cell.appendChild(input);

          const nwrap = document.createElement('div'); nwrap.className='notes';
          for(let k=1;k<=9;k++){ const s=document.createElement('span'); s.textContent=k; s.style.visibility='hidden'; nwrap.appendChild(s); }
          cell.appendChild(nwrap);

          boardEl.appendChild(cell);
        }
      }
    }

    // Generator helpers
    function randomSeeded(seed){
      // xorshift32
      let x = seed|0 || (Math.random()*2**31)|0;
      return function(){
        x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
        return ((x>>>0)/4294967296);
      }
    }
    function shuffle(arr, rnd=Math.random){
      for(let i=arr.length-1;i>0;i--){ const j=(rnd()* (i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }
    function pattern(r,c){ return (BOX*(r%BOX)+Math.floor(r/BOX)+c)%SIZE }
    function generateSolved(rnd=Math.random){
      const rows = [].concat(...[0,1,2].map(g=>[0,1,2].map(r=>g*3+r))).map((_,i)=>i);
      const cols = [].concat(...[0,1,2].map(g=>[0,1,2].map(c=>g*3+c))).map((_,i)=>i);
      const nums = shuffle([1,2,3,4,5,6,7,8,9],rnd);
      const rowOrder = shuffle([0,1,2],rnd).flatMap(b=>shuffle([0,1,2],rnd).map(r=>b*3+r));
      const colOrder = shuffle([0,1,2],rnd).flatMap(b=>shuffle([0,1,2],rnd).map(c=>b*3+c));
      const grid = [];
      for(let r=0;r<9;r++){
        for(let c=0;c<9;c++){
          grid.push(nums[ pattern(rowOrder[r], colOrder[c]) ]);
        }
      }
      return grid;
    }

    // Solver with backtracking; can count solutions up to 2 (for uniqueness check)
    function solve(grid, countOnly=false, limit=2){
      const g = grid.slice();
      const rows=[...Array(9)].map(()=>new Set());
      const cols=[...Array(9)].map(()=>new Set());
      const boxes=[...Array(9)].map(()=>new Set());
      for(let i=0;i<81;i++){
        const v=g[i]; if(!v) continue;
        const [r,c]=rc(i); const b=(Math.floor(r/3)*3+Math.floor(c/3));
        rows[r].add(v); cols[c].add(v); boxes[b].add(v);
      }
      const empties=[];
      for(let i=0;i<81;i++) if(!g[i]) empties.push(i);
      let solutions=0;

      function dfs(k){
        if(solutions>=limit) return;
        if(k===empties.length){ solutions++; return; }
        const i = empties[k]; const [r,c]=rc(i); const b=(Math.floor(r/3)*3+Math.floor(c/3));
        for(let d=1;d<=9;d++){
          if(rows[r].has(d)||cols[c].has(d)||boxes[b].has(d)) continue;
          g[i]=d; rows[r].add(d); cols[c].add(d); boxes[b].add(d);
          dfs(k+1);
          if(solutions>=limit) return;
          g[i]=0; rows[r].delete(d); cols[c].delete(d); boxes[b].delete(d);
        }
      }
      dfs(0);
      if(countOnly) return solutions;
      if(solutions>=1){
        // run once more to get one solved grid
        const solved = g.slice();
        // For speed, just return a solved version using separate single-solution pass
        const s = grid.slice();
        solveFill(s);
        return s;
      }
      return null;

      function solveFill(gd){
        const pos = findEmpty(gd);
        if(pos<0) return true;
        const [r,c]=rc(pos);
        for(let d=1;d<=9;d++){
          if(isSafe(gd,r,c,d)){
            gd[pos]=d;
            if(solveFill(gd)) return true;
            gd[pos]=0;
          }
        }
        return false;
      }
      function findEmpty(gd){ for(let i=0;i<81;i++) if(!gd[i]) return i; return -1;}
      function isSafe(gd,r,c,d){
        for(let x=0;x<9;x++) if(gd[idx(r,x)]===d||gd[idx(x,c)]===d) return false;
        const br=r-r%3, bc=c-c%3;
        for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) if(gd[idx(br+rr,bc+cc)]===d) return false;
        return true;
      }
    }

    function makePuzzle(solved, givens=36, rnd=Math.random){
      const p = solved.slice();
      // Remove symmetric pairs while preserving uniqueness
      const positions = shuffle([...Array(81).keys()], rnd);
      let removed = 0;
      for(const i of positions){
        const j = 80 - i; // simple symmetry
        const keepI = p[i], keepJ = p[j];
        if(keepI===0 && keepJ===0) continue;
        p[i]=0; p[j]=0;
        const sols = solve(p, true, 2);
        if(sols!==1){ // not unique -> revert
          p[i]=keepI; p[j]=keepJ;
        }else{
          removed += (keepI?1:0) + (keepJ?1:0);
          // stop when target reached
          const currentGivens = p.filter(v=>v!==0).length;
          if(currentGivens<=givens) break;
        }
      }
      return p;
    }

    /* ========= Game State & UI ========= */
    function render(){
      qsa('.cell').forEach(cell=>{
        const i = +cell.dataset.i;
        const v = puzzle[i];
        const input = cell.querySelector('input');
        const nwrap = cell.querySelector('.notes');
        cell.classList.toggle('fixed', fixed.has(i));
        input.value = v? v : '';
        // notes
        const spans = nwrap.children;
        for(let k=1;k<=9;k++){
          spans[k-1].style.visibility = notes[i].has(k)? 'visible':'hidden';
        }
        // highlight same numbers
        const selV = (selected>=0)? puzzle[selected] : 0;
        cell.classList.toggle('same', v && selected>=0 && v===selV && i!==selected);
        // conflicts
        cell.classList.toggle('conflict', hasConflict(i, v));
        // selected
        cell.classList.toggle('selected', i===selected);
      });
    }

    function hasConflict(i, val){
      if(!val) return false;
      const [r,c]=rc(i);
      // row/col
      for(let x=0;x<9;x++){
        const ii = idx(r,x); if(ii!==i && puzzle[ii]===val) return true;
        const jj = idx(x,c); if(jj!==i && puzzle[jj]===val) return true;
      }
      // box
      const br=r-r%3, bc=c-c%3;
      for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++){
        const kk=idx(br+rr, bc+cc); if(kk!==i && puzzle[kk]===val) return true;
      }
      return false;
    }

    function select(i){
      selected = i;
      render();
    }

    function placeNumber(n){
      if(selected<0 || fixed.has(selected)) return;
      historyPush();

      if(notesMode && n>0){
        if(puzzle[selected]){ puzzle[selected]=0; }
        if(notes[selected].has(n)) notes[selected].delete(n); else notes[selected].add(n);
      }else{
        notes[selected].clear();
        puzzle[selected] = n;
      }
      autoClearNotesAround(selected, n);
      render();
      persist();
      if(isComplete()){
        finish();
      }
    }

    function autoClearNotesAround(i,n){
      if(!n) return;
      const [r,c]=rc(i); const br=r-r%3, bc=c-c%3;
      for(let x=0;x<9;x++){ notes[idx(r,x)].delete(n); notes[idx(x,c)].delete(n); }
      for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) notes[idx(br+rr,bc+cc)].delete(n);
    }

    function isComplete(){
      if(puzzle.some(v=>!v)) return false;
      // validate all rows/cols/boxes
      const ok = (arr)=>arr.slice().sort().join('')==='123456789';
      for(let r=0;r<9;r++){
        const row=[]; for(let c=0;c<9;c++) row.push(puzzle[idx(r,c)]);
        if(!ok(row)) return false;
      }
      for(let c=0;c<9;c++){
        const col=[]; for(let r=0;r<9;r++) col.push(puzzle[idx(r,c)]);
        if(!ok(col)) return false;
      }
      for(let br=0;br<9;br+=3){
        for(let bc=0;bc<9;bc+=3){
          const box=[]; for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) box.push(puzzle[idx(br+rr,bc+cc)]);
          if(!ok(box)) return false;
        }
      }
      return true;
    }

    function historyPush(){
      historyStack.push({
        puzzle: puzzle.slice(),
        notes: notes.map(s=>new Set([...s])),
        selected
      });
      if(historyStack.length>150) historyStack.shift();
    }
    function undo(){
      const prev = historyStack.pop();
      if(!prev) return;
      puzzle = prev.puzzle.slice();
      notes = prev.notes.map(s=>new Set([...s]));
      selected = prev.selected;
      render(); persist();
    }

    function toggleNotes(){
      notesMode = !notesMode;
      notesBtn.textContent = `Notes: ${notesMode? 'On':'Off'}`;
      notesBtn.setAttribute('aria-pressed', notesMode?'true':'false');
    }

    function tick(){
      if(timer.paused) return;
      const now = performance.now();
      timer.elapsed = Math.floor((now - timer.startAt)/1000);
      timerEl.textContent = fmtTime(timer.elapsed);
      timer.id = requestAnimationFrame(tick);
    }

    function startTimer(){
      timer.startAt = performance.now() - timer.elapsed*1000;
      timer.paused=false;
      cancelAnimationFrame(timer.id);
      timer.id = requestAnimationFrame(tick);
    }
    function pauseTimer(){
      timer.paused=true;
      cancelAnimationFrame(timer.id);
      timer.id=0;
    }
    function resetTimer(){ pauseTimer(); timer.elapsed=0; timerEl.textContent='00:00'; }

    function finish(){
      pauseTimer();
      // Save best time per difficulty
      const key = `sudoku_best_${difficulty}`;
      const prev = parseInt(getCookie(key)||'0',10);
      if(!prev || timer.elapsed < prev) setCookie(key, String(timer.elapsed));
      bestEl.textContent = fmtTime(parseInt(getCookie(key)||timer.elapsed,10));
      alert(`🎉 Completed in ${fmtTime(timer.elapsed)}!`);
    }

    function hint(){
      if(selected<0 || fixed.has(selected)) return;
      const [r,c] = rc(selected);
      const v = solution[selected];
      if(!v) return;
      placeNumber(v);
    }

    function validate(){
      let errors=0;
      for(let i=0;i<81;i++){
        if(!puzzle[i]) continue;
        if(hasConflict(i,puzzle[i])) errors++;
      }
      if(errors===0){
        alert('✅ No conflicts found.');
      }else{
        alert(`⚠️ ${errors} conflict${errors>1?'s':''} found. Conflicting cells show a red border.`);
      }
    }

    function bestTimeLabel(){
      const t = parseInt(getCookie(`sudoku_best_${difficulty}`)||'0',10);
      bestEl.textContent = t? fmtTime(t): '—';
    }

    function persist(){
      // Save essential state in cookies
      setCookie('sudoku_diff', difficulty);
      setCookie('sudoku_elapsed', String(timer.elapsed));
      setCookie('sudoku_puzzle', JSON.stringify(puzzle));
      setCookie('sudoku_solution', JSON.stringify(solution));
      setCookie('sudoku_fixed', JSON.stringify([...fixed]));
      setCookie('sudoku_notes', JSON.stringify(notes.map(s=>[...s])));
      setCookie('sudoku_selected', String(selected));
      // best times handled in finish()
    }

    function restore(){
      const P = getCookie('sudoku_puzzle'); const S = getCookie('sudoku_solution');
      if(!P || !S) return false;
      try{
        puzzle = JSON.parse(P); solution = JSON.parse(S);
        fixed = new Set(JSON.parse(getCookie('sudoku_fixed')||'[]'));
        const N = JSON.parse(getCookie('sudoku_notes')||'[]');
        if(N.length===81) notes = N.map(arr=>new Set(arr));
        selected = parseInt(getCookie('sudoku_selected')||'-1',10);
        timer.elapsed = parseInt(getCookie('sudoku_elapsed')||'0',10) || 0;
        difficulty = getCookie('sudoku_diff') || 'Easy';
        diffEl.textContent = difficulty;
        bestTimeLabel();
        render();
        timerEl.textContent = fmtTime(timer.elapsed);
        return true;
      }catch{ return false; }
    }

    function newGame(diff = difficulty, seed){
      // Stop scrolling & reset timer
      resetTimer();
      difficulty = diff;
      diffEl.textContent = difficulty;
      bestTimeLabel();

      const rnd = seed? randomSeeded(hashCode(seed)) : Math.random;
      solution = generateSolved(typeof rnd==='function'? rnd : Math.random);
      const givens = DIFF_MAP[diff] || 36;
      puzzle = makePuzzle(solution, givens, typeof rnd==='function'? rnd : Math.random);
      fixed = new Set(puzzle.map((v,i)=>v?i:null).filter(v=>v!==null));
      notes = Array(81).fill(0).map(()=>new Set());
      selected = puzzle.findIndex(v=>v===0);
      historyStack = [];
      render();

      // persist state & start timer
      persist();
      startTimer();
    }

    function hashCode(str){
      let h=2166136261>>>0; // FNV-1a
      for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0;}
      return h|0;
    }

    // UI events
    function bindEvents(){
      // cell click
      on(boardEl,'click',e=>{
        const cell = e.target.closest('.cell'); if(!cell) return;
        select(+cell.dataset.i);
      });
      // keyboard
      on(window,'keydown',e=>{
        if(e.key>='1' && e.key<='9') placeNumber(+e.key);
        else if(e.key==='Backspace' || e.key==='Delete' || e.key==='0') placeNumber(0);
        else if(e.key==='h' || e.key==='H') hint();
        else if(e.key==='p' || e.key==='P') toggleNotes();
        else if(e.key==='z' && (e.ctrlKey||e.metaKey)) { e.preventDefault(); undo(); }
        else if(e.key==='ArrowUp'){ moveSel(-1,0); }
        else if(e.key==='ArrowDown'){ moveSel(1,0); }
        else if(e.key==='ArrowLeft'){ moveSel(0,-1); }
        else if(e.key==='ArrowRight'){ moveSel(0,1); }
      });

      function moveSel(dr,dc){
        if(selected<0){ select(0); return; }
        const [r,c]=rc(selected);
        const nr = clamp(r+dr,0,8), nc=clamp(c+dc,0,8);
        select(idx(nr,nc));
      }

      // keypad
      qsa('.key').forEach(k=>on(k,'click',()=>{
        const v = +k.dataset.k;
        placeNumber(v);
      }));

      // buttons
      on(notesBtn,'click', toggleNotes);
      on(hintBtn,'click', hint);
      on(undoBtn,'click', undo);
      on(checkBtn,'click', validate);
      on(newBtn,'click', ()=>{
        const opt = prompt('Difficulty? (Easy / Medium / Hard / Expert)', difficulty) || difficulty;
        newGame(cap(opt.trim()));
      });
      on(pauseBtn,'click', ()=>{
        if(timer.paused){ startTimer(); pauseBtn.textContent='⏸ Pause'; }
        else { pauseTimer(); pauseBtn.textContent='▶️ Resume'; }
      });
      on(shareBtn,'click', shareChallenge);
      on(backBtn,'click', ()=>{
        pauseTimer();
        if(history.length>1) history.back();
        else location.href = '/games/';
      });

      // Pause on blur
      on(document,'visibilitychange', ()=>{ if(document.hidden) { pauseTimer(); pauseBtn.textContent='▶️ Resume'; } });

      // Select first empty on tap board background
      on(boardEl,'click',e=>{ if(e.target===boardEl) select(puzzle.findIndex(v=>v===0)); });
    }

    function cap(s){ s=s.toLowerCase(); return s[0].toUpperCase()+s.slice(1); }

    async function shareChallenge(){
      // Build deterministic seed from current solution (or random)
      const seed = (seedFromUrl || (Date.now().toString(36)+Math.random().toString(36).slice(2,7)));
      const u = new URL(location.href);
      u.searchParams.set('seed', seed);
      u.searchParams.set('diff', difficulty);
      const url = u.toString();
      const text = `I challenge you to beat my Sudoku time on ${difficulty} at UpTools!`;

      try{
        if(navigator.share){
          await navigator.share({title:'Sudoku Challenge • UpTools', text, url});
        }else{
          const ok = await copyToClipboard(url);
          alert(ok? 'Link copied! Share it with your friends.' : url);
        }
      }catch(e){
        // fallback to clipboard
        const ok = await copyToClipboard(url);
        alert(ok? 'Link copied! Share it with your friends.' : url);
      }
    }

    /* ========= Boot ========= */
    buildBoard();
    bindEvents();

    // If URL has seed/diff, create deterministic puzzle
    if(diffFromUrl){ difficulty = cap(diffFromUrl); }
    if(seedFromUrl){
      newGame(difficulty, seedFromUrl);
    }else if(!restore()){
      // else start fresh
      newGame('Easy');
    }

    // Insert backlinks from generate-seo.mjs if present (non-blocking)
    (async function loadSeoLinks(){
      try{
        const mod = await import('/generate-seo.mjs');
        const zone = document.getElementById('seo-links');
        const links = (mod?.links || mod?.default || []);
        if(Array.isArray(links) && links.length){
          zone.innerHTML = '';
          links.slice(0,8).forEach(l=>{
            const a = document.createElement('a');
            a.href = l.href; a.textContent = l.text || l.title || l.href;
            a.rel = 'noopener';
            zone.appendChild(a);
          });
        }
      }catch{ /* optional */ }
    })();

  })();
  </script>
</body>
</html>