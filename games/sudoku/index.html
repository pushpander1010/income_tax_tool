<!doctype html>
<html lang="en">
<head>
  <!-- Single async ad -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6216304334889617" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
  <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sudoku ‚Äì Free Online Game (Neon Dark, Mobile-Perfect) | UpTools</title>

  <!-- SEO -->
  <meta name="description" content="Play Sudoku in a neon-dark theme. Fully responsive full-screen board, visible background animation, correct mistakes logic with counter, timer, notes & autosave." />
  <meta name="keywords" content="sudoku, play sudoku, sudoku online, neon sudoku, dark sudoku, mobile sudoku, notes, timer" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:large" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="canonical" href="https://www.uptools.in/games/sudoku/" />

  <!-- OpenGraph / Twitter -->
  <meta property="og:title" content="Play Sudoku ‚Äì Free Online (Neon Dark) | UpTools" />
  <meta property="og:description" content="Responsive, full-screen Sudoku with notes, mistake counter, and autosave. Challenge friends!" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.uptools.in/games/sudoku/" />
  <meta property="og:image" content="https://www.uptools.in/assets/social/sudoku-card.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Favicons -->
  <link rel="icon" sizes="50x50" type="image/svg+xml" href="/assets/logo/uptools-logo.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/uptools-logo.svg">

  <!-- Base CSS -->
  <link rel="preload" href="/style.css?v=1.3.0" as="style">
  <link rel="stylesheet" href="/style.css?v=1.3.0" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="/style.css?v=1.3.0"></noscript>

  <style>
    :root{
      --accent:#63e5ff;      /* neon cyan */
      --accent2:#b06cff;     /* neon purple */
      --good:#8bffb0;        /* mint */
      --danger:#ff6b6b;
      --bg:#0b1020;
      --card:#0e1526;
      --cardBorder:#223249;
      --muted:#9aa4b2;
      --bar-h:46px;
    }
    @media (max-width:380px){ :root{ --bar-h:44px; } }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; color:#e6edf3; background:#0b1020; min-height:100svh; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"; touch-action: manipulation; }
    .game-wrap{ max-width:1100px; margin:0 auto; padding:1rem; }

    .panel{ background:var(--card); border:1px solid var(--cardBorder); border-radius:.85rem; box-shadow:0 6px 30px rgba(0,0,0,.25); padding:1rem; margin:0 auto; }
    .hud{ display:grid; grid-template-columns:repeat(5,1fr); gap:.75rem; align-items:center; margin-bottom:.75rem; }
    .kpi{ text-align:center; padding:.5rem .75rem; border:1px solid var(--cardBorder); border-radius:.75rem; background:rgba(255,255,255,.02); }
    .kpi .value{ font-size:1.1rem; font-weight:800; color:var(--accent); }
    .kpi .label{ font-size:.75rem; color:var(--muted); }
    @media (max-width:900px){ .hud{ grid-template-columns:repeat(3,1fr);} }
    @media (max-width:560px){ .hud{ grid-template-columns:repeat(2,1fr);} }

    .row{ display:flex; gap:.5rem; align-items:center; justify-content:center; flex-wrap:wrap; }
    .controls{ display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin:.75rem 0 0; }
    .btn{ padding:.66rem 1.05rem; border:none; border-radius:.75rem; font-weight:800; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
    .btn.primary{ background:var(--accent); color:#0b1020; }
    .btn.secondary{ background:transparent; color:#e6edf3; border:1px solid var(--cardBorder); }
    .btn.danger{ background:var(--danger); color:#0b1020; }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 26px rgba(0,0,0,.25); }

    select{ background:#0f151f; color:#e6edf3; border:1px solid var(--cardBorder); border-radius:.6rem; padding:.55rem .7rem; font-weight:700; }
    .status{ text-align:center; margin:.75rem 0 0; color:#9fb1c6; font-weight:600; }

    /* ======= Full-screen Play Window ======= */
    #playScreen{
      position:fixed; inset:0; display:none; z-index:50;
      background:linear-gradient(180deg, rgba(7,12,20,.965), rgba(9,14,22,.985));
      padding:max(6px,env(safe-area-inset-top)) clamp(8px,2vw,16px) max(8px,env(safe-area-inset-bottom));
      box-sizing:border-box; height:100svh; width:100svw;
      overscroll-behavior:none; touch-action:none; overflow:clip;
    }
    #playScreen.open{ display:grid; grid-template-rows:var(--bar-h) 1fr; }

    .ps-top{
      height:var(--bar-h);
      background:rgba(255,255,255,.03);
      border:1px solid var(--cardBorder);
      border-radius:.65rem;
      padding:0 .5rem;
      display:flex; align-items:center; justify-content:space-between; gap:.35rem; min-width:0;
    }
    .ps-top > *{ min-width:0; display:flex; align-items:center; gap:.35rem; }
    .left,.mid,.right{ flex:1 1 0; }
    .left{ justify-content:flex-start; }
    .mid{ justify-content:center; flex-wrap:nowrap; }
    .right{ justify-content:flex-end; }
    .ps-title{ font-weight:900; white-space:nowrap; }
    @media (max-width:500px){ .ps-title{ display:none; } }
    .ps-chip,.ps-btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:calc(var(--bar-h) - 10px);
      padding:0 .55rem;
      border-radius:.55rem; border:1px solid var(--cardBorder);
      background:#0f151f; color:#e6edf3; font-weight:800;
      font-size:clamp(.78rem,2.2vw,.95rem);
      white-space:nowrap; min-width:0;
    }
    .ps-btn.primary{ background:var(--accent); color:#0b1020; border-color:var(--accent); }
    .chip-full{ display:inline; } .chip-short{ display:none; }
    @media (max-width:430px){ .chip-full{ display:none;} .chip-short{ display:inline; } }

    .ps-stage{ min-height:0; display:grid; align-items:center; justify-items:center; }
    .board{
      width:100%; height:100%;
      background:radial-gradient(100% 140% at 15% 10%, #0d1630 0%, #0b1226 55%, #08101e 100%);
      border:1px solid var(--cardBorder);
      border-radius:.85rem; padding: clamp(8px, 1.6vw, 16px);
      display:grid; grid-template-rows: auto 1fr auto; gap: clamp(8px,1.4vw,14px);
      position:relative; min-height:0;
    }

    /* floating chips over the grid */
    .board-chips{
      display:flex; justify-content:center; gap:.5rem; align-items:center;
      pointer-events:none; /* don't block taps */
    }
    .chip{
      pointer-events:auto;
      display:inline-flex; align-items:center; justify-content:center;
      padding:.28rem .6rem; border-radius:.6rem; border:1px solid rgba(99,229,255,.45);
      background: radial-gradient(100% 100% at 50% 0%, rgba(99,229,255,.14), rgba(176,108,255,.10));
      font-weight:900; font-size:.85rem;
      box-shadow: 0 4px 14px rgba(0,0,0,.25), inset 0 0 14px rgba(99,229,255,.12);
    }

    /* Grid wrapper row uses all remaining space ‚Äì square enforced via JS */
    .grid-wrap{
      display:grid; place-items:center; min-height:0; min-width:0;
    }

    .sudoku-wrap{
      place-self:center;
      inline-size: 100px;   /* JS will set real size */
      block-size: 100px;    /* JS will set real size */
      display:grid; grid-template-columns: repeat(9, 1fr); grid-auto-rows: 1fr;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border-radius:.75rem; padding: clamp(6px, 1vw, 10px);
      box-shadow: 0 0 0 1px rgba(99,229,255,.22), inset 0 0 30px rgba(176,108,255,.08);
      position:relative; min-height:0; min-width:0;
    }
    .cell{
      position:relative; display:grid; place-items:center; user-select:none; cursor:pointer;
      border:1px solid rgba(255,255,255,.06);
      font-weight:900; font-size: clamp(14px, 2.8vmin, 28px);
      color:#e6edf3; text-shadow: 0 0 6px rgba(99,229,255,.4);
      transition: background .12s ease, box-shadow .12s ease, transform .06s ease;
      background:rgba(8,14,26,.5);
    }
    .cell[data-r="2"], .cell[data-r="5"]{ border-bottom: 2px solid rgba(99,229,255,.38); }
    .cell[data-c="2"], .cell[data-c="5"]{ border-right:  2px solid rgba(99,229,255,.38); }

    .cell.prefilled{ color:var(--good); text-shadow: 0 0 8px rgba(139,255,176,.35); }
    .cell.selected{ outline:2px solid var(--accent); z-index:2; box-shadow:0 0 16px rgba(99,229,255,.25) inset; }
    .cell.same{ background:linear-gradient(180deg, rgba(99,229,255,.08), rgba(176,108,255,.08)); }
    .cell.peer{ background:rgba(255,255,255,.04); }
    .cell.error{ background:rgba(255,107,107,.14); box-shadow: inset 0 0 18px rgba(255,107,107,.28); }

    .note{
      position:absolute; inset:0; display:grid; grid-template-columns: repeat(3,1fr); grid-auto-rows:1fr;
      font-weight:700; font-size: clamp(8px, 1.6vmin, 14px); color:#9fb1c6; opacity:.95; pointer-events:none;
    }
    .note span{ display:grid; place-items:center; }

    /* Keypad (fixed height on small screens for predictability) */
    .keypad{
      display:grid; grid-template-columns:repeat(10, 1fr); gap: clamp(6px,1.2vw,12px);
    }
    .key{
      user-select:none; padding: clamp(10px, 2.2vw, 14px) 0;
      border-radius:.7rem; border:1px solid rgba(99,229,255,.35);
      background: radial-gradient(100% 100% at 50% 0%, rgba(99,229,255,.12), rgba(176,108,255,.10));
      font-weight:900; text-align:center; cursor:pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.25), inset 0 0 18px rgba(99,229,255,.12);
      transition: transform .06s ease, box-shadow .1s ease;
    }
    .key:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.28), inset 0 0 22px rgba(176,108,255,.16); }
    .key.sec{ border-style:dashed; color:#e6edf3; }
    .key.wide{ grid-column: span 2; }
    .key.on{ outline:2px solid var(--accent2); }

    /* overlay */
    .overlay{
      position:absolute; inset: clamp(8px,1.2vw,12px);
      display:none; place-items:center; z-index:5;
      background:rgba(5,10,18,.55);
      border-radius:.65rem; border:1px solid rgba(255,255,255,.08);
      text-align:center; padding: clamp(10px, 2vw, 16px);
    }
    .overlay.show{ display:grid; }
    .overlay h3{ margin:.2rem 0 .6rem; }

    /* Visible, lightweight background animation */
    .bg-canvas{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background: radial-gradient(1100px 700px at 10% -10%, #101a34 0%, var(--bg) 45%) fixed;
    }
  </style>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"VideoGame","name":"Sudoku","url":"https://www.uptools.in/games/sudoku/","applicationCategory":"Game","genre":"Puzzle","operatingSystem":"Browser","inLanguage":"en","publisher":{"@type":"Organization","name":"UpTools","url":"https://www.uptools.in/"},"offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}
  </script>
</head>
<body>
  <!-- Background animation -->
  <canvas id="bgCanvas" class="bg-canvas" aria-hidden="true"></canvas>

  <!-- Header -->
  <header class="site" role="banner">
    <div class="header-inner">
      <a class="brand" href="/" aria-label="UpTools Home">
        <img src="/assets/logo/uptools-logo.svg" alt="UpTools logo" width="28" height="28" loading="eager">
        <b>UpTools</b>
      </a>
      <nav class="nav-links" aria-label="Primary">
        <a href="/#tools">Tools</a>
        <a aria-current="page" href="/games/">Games</a>
        <a href="/about/">About</a>
        <a href="/contact/">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Home -->
  <main class="wrap" id="homeScreen">
    <div class="tool-header" style="text-align:center;margin:1rem 0 .25rem">
      <h1>üß© Sudoku (Neon Dark)</h1>
      <p>Tap <b>New Game</b> for a full-screen board. Notes, mistake limit & autosave are built-in.</p>
    </div>

    <div class="game-wrap">
      <section class="panel">
        <div class="hud" aria-live="polite">
          <div class="kpi"><div class="value" id="bestTime">‚Äì</div><div class="label">Best Time</div></div>
          <div class="kpi"><div class="value" id="bestMist">‚Äì</div><div class="label">Fewest Mistakes</div></div>
          <div class="kpi"><div class="value" id="lastTime">‚Äì</div><div class="label">Last Time</div></div>
          <div class="kpi"><div class="value" id="lastMist">‚Äì</div><div class="label">Last Mistakes</div></div>
          <div class="kpi"><div class="value" id="lastDate">‚Äì</div><div class="label">Last Played</div></div>
        </div>

        <div class="row">
          <label for="difficulty"><b>Difficulty</b></label>
          <select id="difficulty">
            <option value="easy">Easy üå±</option>
            <option value="normal" selected>Normal ‚ö°</option>
            <option value="hard">Hard üî•</option>
            <option value="expert">Expert üß†</option>
          </select>
          <label for="mistLimit"><b>Mistakes</b></label>
          <select id="mistLimit">
            <option value="5" selected>5</option>
            <option value="3">3</option>
            <option value="0">Unlimited</option>
          </select>
        </div>

        <div class="controls" role="toolbar" aria-label="Controls">
          <button id="newGame" class="btn primary">New Game</button>
          <button id="continueBtn" class="btn secondary">‚Ü©Ô∏è Continue</button>
          <button id="shareBtn" class="btn secondary">üì£ Challenge Friends</button>
          <button id="resetBest" class="btn danger">Reset Best</button>
        </div>

        <p class="status" id="homeStatus">Tip: tap a cell then use keypad or number keys (1‚Äì9). Toggle <b>Notes</b> with ‚úé or N. Backspace clears.</p>

        <div class="grid" style="display:grid;grid-template-columns:1fr;gap:.75rem;margin-top:1rem">
          <div class="card" style="background:#0b1326;border:1px solid #233351;border-radius:.75rem;padding:.75rem">
            <b>How to play Sudoku</b>
            <p class="status" style="margin:0">Fill the grid so every row, column, and 3√ó3 box has digits 1‚Äì9 with no repeats.</p>
            <div style="aspect-ratio:16/9;border-radius:12px;border:1px solid #233351;background:#0f151f;margin-top:.6rem">
              <iframe width="100%" height="100%" src="https://www.youtube.com/embed/1povwe8Z3gI" title="Sudoku tutorial" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
            <p class="status" style="margin-top:.6rem">
              Also try <a href="/games/2048/" rel="internal">2048</a> ¬∑ <a href="/games/tic-tac-toe/" rel="internal">Tic Tac Toe</a> ¬∑ learn more on
              <a href="https://wikipedia.org/wiki/Sudoku" rel="noopener nofollow">Wikipedia</a>.
            </p>
          </div>
        </div>

        <nav class="nav-links small" style="justify-content:center;margin-top:.75rem">
          Related on UpTools:
          <a href="/games/">All Games</a> ¬∑
          <a href="/image-converter/">Image Converter</a> ¬∑
          <a href="/qr-generator/">QR Code Generator</a> ¬∑
          <a href="/bmi-calculator/">BMI Calculator</a> ¬∑
          <a href="/ifsc-finder/">IFSC Finder</a> ¬∑
          <a href="/gst-calculator/">GST Calculator</a> ¬∑
          <a href="/currency-converter/">Currency Converter</a>
        </nav>
      </section>
    </div>
  </main>

  <!-- FULL-SCREEN Play Window -->
  <section id="playScreen" role="dialog" aria-modal="true" inert>
    <div class="ps-top">
      <div class="left">
        <button id="psBack" class="ps-btn" type="button" aria-label="Back">‚üµ</button>
        <span class="ps-title">Sudoku</span>
      </div>
      <div class="mid" aria-live="polite">
        <span class="ps-chip"><span class="chip-full">Time:</span><span class="chip-short">T:</span>&nbsp;<span id="timeVal">00:00</span></span>
        <span class="ps-chip"><span class="chip-full">Mistakes:</span><span class="chip-short">M:</span>&nbsp;<span id="mistVal">0</span></span>
        <span class="ps-chip"><span class="chip-full">Diff:</span><span class="chip-short">D:</span>&nbsp;<span id="diffVal">Normal</span></span>
        <span class="ps-chip"><span class="chip-full">Best:</span><span class="chip-short">B:</span>&nbsp;<span id="bestVal">‚Äì</span></span>
      </div>
      <div class="right" aria-label="Actions">
        <button id="psNotes" class="ps-btn" title="Toggle Notes">‚úé</button>
        <button id="psRestart" class="ps-btn" title="Restart">‚ü≤</button>
        <button id="psShare" class="ps-btn" title="Share">üîó</button>
      </div>
    </div>

    <div class="ps-stage">
      <div class="board" id="board">
        <!-- chips row (includes Errors Left) -->
        <div class="board-chips">
          <span id="errorsLeft" class="chip" title="Remaining mistakes before game over">Errors Left: ‚àû</span>
        </div>

        <!-- center grid -->
        <div class="grid-wrap">
          <div id="grid" class="sudoku-wrap" role="grid" aria-label="Sudoku grid"></div>
        </div>

        <!-- Keypad -->
        <div class="keypad" role="group" aria-label="Keypad">
          <div class="key" data-k="1">1</div><div class="key" data-k="2">2</div><div class="key" data-k="3">3</div>
          <div class="key" data-k="4">4</div><div class="key" data-k="5">5</div><div class="key" data-k="6">6</div>
          <div class="key" data-k="7">7</div><div class="key" data-k="8">8</div><div class="key" data-k="9">9</div>
          <div class="key sec wide" data-k="0">‚å´ Clear</div>
        </div>

        <!-- overlay -->
        <div id="overlay" class="overlay" aria-hidden="true">
          <div class="panel">
            <h3 id="ovTitle">Paused</h3>
            <p class="status" id="ovDesc">Tap anywhere or press P</p>
            <div class="row" style="margin-top:.5rem">
              <button id="ovResume" class="ps-btn primary">Resume</button>
              <button id="ovRestart" class="ps-btn">Restart</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script defer src="/utils.js?v=1.3.0"></script>
  <script>
    /* ---------- tiny helpers ---------- */
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => [...el.querySelectorAll(s)];
    const clamp = (x, a, b) => Math.min(b, Math.max(a, x));
    const haptic = (ms)=>{ try{ if(navigator.vibrate) navigator.vibrate(ms||8);}catch{} };

    function setCookie(name, value, days=365){
      const d = new Date(Date.now() + days*864e5);
      document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + "; path=/; expires=" + d.toUTCString();
    }

    /* ---------- visible lightweight background animation ---------- */
    (function bgNumbers(){
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d');
      let W=0,H=0, DPR = Math.min(2, window.devicePixelRatio || 1);
      const digits = [];
      function resize(){
        W = canvas.clientWidth = innerWidth;
        H = canvas.clientHeight = innerHeight;
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      addEventListener('resize', resize, {passive:true}); resize();
      const palette = ["#63e5ff","#b06cff","#8bffb0"];
      for(let i=0;i<44;i++){
        digits.push({
          d: 1 + (i%9),
          x: Math.random()*W, y: Math.random()*H,
          vx: (Math.random()*0.6-0.3), vy: (Math.random()*0.5-0.25),
          s: 18 + Math.random()*36,
          c: palette[i%palette.length],
          a: 0.26 + Math.random()*0.18
        });
      }
      let t0=performance.now();
      function tick(t){
        const dt = Math.min(.05,(t-t0)/1000); t0=t;
        ctx.clearRect(0,0,W,H);
        for(const n of digits){
          n.x += n.vx*28*dt; n.y += n.vy*22*dt;
          if(n.x<-60) n.x=W+60; if(n.x>W+60) n.x=-60;
          if(n.y<-60) n.y=H+60; if(n.y>H+60) n.y=-60;
          ctx.save();
          ctx.globalAlpha = n.a;
          ctx.shadowColor = n.c; ctx.shadowBlur = 16;
          ctx.fillStyle = n.c;
          ctx.font = `900 ${n.s}px system-ui`;
          ctx.fillText(String(n.d), n.x, n.y);
          ctx.restore();
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    })();

    /* ---------- Sudoku ---------- */
    const LS = { STATE: "ut_sudoku_state_v2", BEST: "ut_sudoku_best", LAST: "ut_sudoku_last" };
    function mulberry32(seed){ let t = seed>>>0; return ()=>{ t+=0x6D2B79F5; let r=Math.imul(t^t>>>15,1|t); r^=r+Math.imul(r^r>>>7,61|r); return ((r^r>>>14)>>>0)/4294967296; }; }
    function strHash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

    const els = {
      home: $("#homeScreen"), play: $("#playScreen"),
      newGame: $("#newGame"), continueBtn: $("#continueBtn"),
      shareBtn: $("#shareBtn"), resetBest: $("#resetBest"),
      difficulty: $("#difficulty"), mistLimit: $("#mistLimit"),
      homeBest: $("#bestTime"), homeBestMist: $("#bestMist"),
      homeLast: $("#lastTime"), homeLastMist: $("#lastMist"), homeLastDate: $("#lastDate"),
      grid: $("#grid"), board: $("#board"), keypad: $(".keypad"),
      overlay: $("#overlay"), ovTitle: $("#ovTitle"), ovDesc: $("#ovDesc"),
      ovResume: $("#ovResume"), ovRestart: $("#ovRestart"),
      psBack: $("#psBack"), psRestart: $("#psRestart"), psShare: $("#psShare"), psNotes: $("#psNotes"),
      timeVal: $("#timeVal"), mistVal: $("#mistVal"), diffVal: $("#diffVal"), bestVal: $("#bestVal"),
      errorsLeft: $("#errorsLeft")
    };

    const S = {
      paused:false, notesMode:false,
      difficulty:"normal", mistLimit:5, mistakes:0,
      seed:"", rnd: Math.random,
      startAt:0, elapsed:0, timerId:null,
      puzzle: Array.from({length:9},()=>Array(9).fill(0)),
      solution: Array.from({length:9},()=>Array(9).fill(0)),
      given: Array.from({length:9},()=>Array(9).fill(false)),
      notes: Array.from({length:9},()=>Array.from({length:9},()=>new Set())),
      selected: {r:-1,c:-1}
    };

    const fmtTime = (sec)=>{ sec=Math.max(0,sec|0); const h=sec/3600|0, m=(sec%3600)/60|0, s=sec%60; return (h?String(h).padStart(2,'0')+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); };
    function startTimer(){ S.startAt=Date.now()-S.elapsed*1000; stopTimer(); S.timerId=setInterval(()=>{ if(!S.paused){ S.elapsed=(Date.now()-S.startAt)/1000; els.timeVal.textContent=fmtTime(S.elapsed|0); } },1000); }
    function stopTimer(){ if(S.timerId){ clearInterval(S.timerId); S.timerId=null; } }

    function canPlace(grid, r,c,v){
      for(let i=0;i<9;i++){ if(grid[r][i]===v || grid[i][c]===v) return false; }
      const br = Math.floor(r/3)*3, bc = Math.floor(c/3)*3;
      for(let i=0;i<3;i++) for(let j=0;j<3;j++){ if(grid[br+i][bc+j]===v) return false; }
      return true;
    }
    function findEmpty(grid){
      let best=[-1,-1,10];
      for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(grid[r][c]===0){
        let cnt=0; for(let v=1;v<=9;v++) if(canPlace(grid,r,c,v)) cnt++;
        if(cnt<best[2]){ best=[r,c,cnt]; if(cnt===1) return [r,c]; }
      }
      return best[0]===-1 ? null : [best[0], best[1]];
    }
    function solve(grid, rnd){
      const spot = findEmpty(grid); if(!spot) return true;
      const [r,c] = spot; const nums=[1,2,3,4,5,6,7,8,9];
      if(rnd){ for(let i=nums.length-1;i>0;i--){ const j=(rnd()*(i+1))|0; [nums[i],nums[j]]=[nums[j],nums[i]]; } }
      for(const v of nums){ if(canPlace(grid,r,c,v)){ grid[r][c]=v; if(solve(grid, rnd)) return true; grid[r][c]=0; } }
      return false;
    }
    function countSolutions(grid, lim=2){
      const g = grid.map(r=>r.slice()); let count=0;
      (function dfs(){
        const spot=findEmpty(g); if(!spot){ count++; return; }
        const [r,c]=spot;
        for(let v=1;v<=9;v++){ if(canPlace(g,r,c,v)){ g[r][c]=v; if(count<lim) dfs(); g[r][c]=0; if(count>=lim) return; } }
      })();
      return count;
    }

    function generate(seed, diff){
      S.seed = seed||""; S.rnd = S.seed ? mulberry32(strHash(S.seed)) : Math.random;
      const grid=Array.from({length:9},()=>Array(9).fill(0));
      const nums=[1,2,3,4,5,6,7,8,9];
      for(let box=0; box<3; box++){
        const arr=nums.slice(); for(let i=arr.length-1;i>0;i--){ const j=(S.rnd()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; }
        let k=0; for(let r=0;r<3;r++) for(let c=0;c<3;c++){ grid[box*3+r][box*3+c]=arr[k++]; }
      }
      solve(grid, S.rnd);
      const solution = grid.map(r=>r.slice());

      const removals=({easy:40,normal:50,hard:56,expert:60}[diff]) ?? 50;
      const puzzle=solution.map(r=>r.slice());
      const cells=[]; for(let r=0;r<9;r++) for(let c=0;c<9;c++) cells.push([r,c]);
      for(let i=cells.length-1;i>0;i--){ const j=(S.rnd()*(i+1))|0; [cells[i],cells[j]]=[cells[j],cells[i]]; }
      let removed=0;
      for(const [r,c] of cells){
        if(removed>=removals) break;
        const b=puzzle[r][c]; puzzle[r][c]=0;
        if(countSolutions(puzzle,2)!==1) puzzle[r][c]=b; else removed++;
      }

      S.puzzle=puzzle; S.solution=solution; S.given=puzzle.map(row=>row.map(v=>v!==0));
      S.notes=Array.from({length:9},()=>Array.from({length:9},()=>new Set()));
      S.mistakes=0; S.elapsed=0;
    }

    function buildGrid(){
      els.grid.innerHTML="";
      for(let r=0;r<9;r++) for(let c=0;c<9;c++){
        const d=document.createElement("div");
        d.className="cell"; d.dataset.r=String(r); d.dataset.c=String(c);
        const val=S.puzzle[r][c];
        if(val){ d.textContent=String(val); d.classList.add("prefilled"); }
        const notes=document.createElement("div"); notes.className="note";
        for(let k=1;k<=9;k++){ const s=document.createElement("span"); s.textContent=""; notes.appendChild(s); }
        d.appendChild(notes);
        d.addEventListener("click",()=>selectCell(r,c));
        els.grid.appendChild(d);
      }
      refreshSelection(); refreshNotesAll(); refreshErrorsAll();
      fitGridSquare(); setTimeout(fitGridSquare, 0); // ensure layout pass complete
    }

    function fitGridSquare(){
      // Make the grid fill the available stage (minus keypad) as a perfect square
      const board = els.board; const keypad = els.keypad;
      const cs=getComputedStyle(board);
      const padY = parseFloat(cs.paddingTop)+parseFloat(cs.paddingBottom);
      const padX = parseFloat(cs.paddingLeft)+parseFloat(cs.paddingRight);
      const availW = board.clientWidth - padX;
      const availH = board.clientHeight - padY - keypad.offsetHeight - 10; // gap
      const size = Math.max(260, Math.min(availW, availH));
      els.grid.style.inlineSize = size+"px";
      els.grid.style.blockSize  = size+"px";
    }
    new ResizeObserver(fitGridSquare).observe(els.board);
    new ResizeObserver(fitGridSquare).observe(els.keypad);
    if(window.visualViewport){ visualViewport.addEventListener("resize", fitGridSquare); }
    addEventListener("orientationchange", fitGridSquare, {passive:true});
    addEventListener("resize", fitGridSquare, {passive:true});

    function refreshSelection(){
      $$(".cell", els.grid).forEach(el=>el.classList.remove("selected","peer","same"));
      const {r,c}=S.selected; if(r<0||c<0) return;
      const cur=$(`.cell[data-r="${r}"][data-c="${c}"]`, els.grid); cur?.classList.add("selected");
      for(let i=0;i<9;i++){
        $(`.cell[data-r="${r}"][data-c="${i}"]`, els.grid)?.classList.add("peer");
        $(`.cell[data-r="${i}"][data-c="${c}"]`, els.grid)?.classList.add("peer");
      }
      const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
      for(let i=0;i<3;i++) for(let j=0;j<3;j++){
        $(`.cell[data-r="${br+i}"][data-c="${bc+j}"]`, els.grid)?.classList.add("peer");
      }
      const v=S.puzzle[r][c];
      if(v){ $$(".cell", els.grid).forEach(node=>{ const rr=+node.dataset.r, cc=+node.dataset.c; if(S.puzzle[rr][cc]===v) node.classList.add("same"); }); }
    }

    function refreshErrorsAll(){
      // purely visual duplicate highlight (won't affect mistakes logic)
      for(let r=0;r<9;r++) for(let c=0;c<9;c++){
        const el=$(`.cell[data-r="${r}"][data-c="${c}"]`, els.grid); el?.classList.remove("error");
        const v=S.puzzle[r][c]; if(v===0) continue;
        for(let i=0;i<9;i++){
          if(i!==c && S.puzzle[r][i]===v){ el?.classList.add("error"); break; }
          if(i!==r && S.puzzle[i][c]===v){ el?.classList.add("error"); break; }
        }
        const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
        for(let i=0;i<3;i++) for(let j=0;j<3;j++){
          const rr=br+i, cc=bc+j;
          if((rr!==r||cc!==c) && S.puzzle[rr][cc]===v){ el?.classList.add("error"); i=3; j=3; }
        }
      }
    }

    function refreshNotesCell(r,c){
      const n=$(`.cell[data-r="${r}"][data-c="${c}"] .note`, els.grid); if(!n) return;
      const set=S.notes[r][c]; [...n.children].forEach((span,idx)=>{ const k=idx+1; span.textContent=set.has(k)?String(k):""; });
    }
    function refreshNotesAll(){ for(let r=0;r<9;r++) for(let c=0;c<9;c++) refreshNotesCell(r,c); }

    function updateErrorsLeft(){
      const left = S.mistLimit===0 ? "‚àû" : Math.max(0, S.mistLimit - S.mistakes);
      els.errorsLeft.textContent = `Errors Left: ${left}`;
    }

    /* ---------- Gameflow ---------- */
    function openPlay(seedFromURL, diffFromURL){
      setInert(els.home, true); setInert(els.play, false);
      els.play.classList.add("open");
      S.difficulty = diffFromURL || els.difficulty.value;
      S.mistLimit = Number(els.mistLimit.value);
      $("#diffVal").textContent = S.difficulty[0].toUpperCase()+S.difficulty.slice(1);
      generate(seedFromURL||"", S.difficulty);
      buildGrid();
      S.selected={r:-1,c:-1};
      S.paused=false; S.mistakes=0; S.elapsed=0;
      els.mistVal.textContent = "0";
      updateErrorsLeft();
      startTimer();
      updateHUD();
      $("#psBack").focus({preventScroll:true});
      updateHomeStats();
    }
    function closePlay(){
      stopTimer();
      els.play.classList.remove("open");
      setInert(els.play,true); setInert(els.home,false);
      $("#newGame").focus({preventScroll:true});
      saveLocal(); updateHomeStats();
    }
    function setInert(el,val){ if(val){ el.setAttribute("inert",""); el.inert=true; } else { el.removeAttribute("inert"); el.inert=false; } }

    function selectCell(r,c){ S.selected={r,c}; refreshSelection(); }

    // ‚úÖ Correct mistakes logic:
    // - Wrong number does NOT get placed.
    // - We increment mistakes once per wrong attempt and update "Errors Left".
    // - Game ends only when limit reached (unless Unlimited).
    function placeNumber(k){
      const {r,c}=S.selected; if(r<0||c<0) return;
      if(S.given[r][c]) return;

      if(S.notesMode){
        if(S.puzzle[r][c]!==0) return;
        const set=S.notes[r][c];
        if(k===0) set.clear(); else (set.has(k)?set.delete(k):set.add(k));
        refreshNotesCell(r,c); haptic(8); saveLocal(); return;
      }

      if(k===0){ S.puzzle[r][c]=0; refreshCell(r,c); refreshErrorsAll(); haptic(10); saveLocal(); return; }

      if(S.solution[r][c]===k){
        S.puzzle[r][c]=k; S.notes[r][c].clear();
        refreshCell(r,c); refreshErrorsAll(); haptic(8);
        if(checkWin()) onWin();
      }else{
        // wrong try: animate + count, but don't change grid
        S.mistakes++; els.mistVal.textContent=String(S.mistakes);
        updateErrorsLeft();
        const el=$(`.cell[data-r="${r}"][data-c="${c}"]`, els.grid);
        el?.animate([{transform:'scale(1)'},{transform:'scale(0.96)'},{transform:'scale(1)'}],{duration:180});
        haptic(30);
        if(S.mistLimit>0 && S.mistakes>=S.mistLimit) onGameOver();
      }
      saveLocal();
    }

    function refreshCell(r,c){
      const el=$(`.cell[data-r="${r}"][data-c="${c}"]`, els.grid); if(!el) return;
      const v=S.puzzle[r][c]; el.textContent = v?String(v):"";
      if(!v){
        const notes=document.createElement("div"); notes.className="note";
        for(let k=1;k<=9;k++){ const s=document.createElement("span"); s.textContent=S.notes[r][c].has(k)?String(k):""; notes.appendChild(s); }
        el.appendChild(notes);
      }else{ if(!S.given[r][c]) el.classList.remove("prefilled"); }
      refreshSelection();
    }

    function checkWin(){ for(let r=0;r<9;r++) for(let c=0;c<9;c++){ if(S.puzzle[r][c]!==S.solution[r][c]) return false; } return true; }

    function updateHUD(){
      els.mistVal.textContent = String(S.mistakes);
      els.timeVal.textContent = fmtTime(S.elapsed|0);
      const best = loadBestFor(S.difficulty);
      els.bestVal.textContent = best ? `${fmtTime(best.time)} / ${best.mist}‚ùå` : "‚Äì";
    }

    function showOverlay(title,desc){
      $("#ovTitle").textContent=title; $("#ovDesc").textContent=desc;
      els.overlay.classList.add("show"); els.overlay.setAttribute("aria-hidden","false"); S.paused=true;
    }
    function hideOverlay(){ els.overlay.classList.remove("show"); els.overlay.setAttribute("aria-hidden","true"); S.paused=false; }

    function onWin(){
      stopTimer();
      const time=S.elapsed|0;
      saveLast({time, mistakes:S.mistakes, diff:S.difficulty});
      maybeSaveBest(time,S.mistakes,S.difficulty);
      updateHomeStats(); updateHUD();
      showOverlay("You Win! üéâ", `Time: ${fmtTime(time)} ¬∑ Mistakes: ${S.mistakes}`);
    }
    function onGameOver(){
      stopTimer();
      const time=S.elapsed|0;
      saveLast({time, mistakes:S.mistakes, diff:S.difficulty});
      updateHomeStats();
      showOverlay("Game Over", `Mistake limit reached. Time: ${fmtTime(time)}`);
    }

    /* ---------- Storage ---------- */
    function saveLocal(){
      const obj={ difficulty:S.difficulty, seed:S.seed, mistLimit:S.mistLimit,
        puzzle:S.puzzle, solution:S.solution, given:S.given,
        notes:S.notes.map(row=>row.map(set=>Array.from(set))),
        mistakes:S.mistakes, elapsed:S.elapsed };
      localStorage.setItem(LS.STATE, JSON.stringify(obj));
      localStorage.setItem(LS.LAST, JSON.stringify({time:S.elapsed|0, mistakes:S.mistakes, diff:S.difficulty, at:Date.now()}));
    }
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS.STATE)||"null"); }catch{return null;} }
    function saveLast(data){ localStorage.setItem(LS.LAST, JSON.stringify({...data, at: Date.now()})); }
    function loadBestFor(diff){ try{ const all=JSON.parse(localStorage.getItem(LS.BEST)||"{}"); return all[diff]||null; }catch{ return null; } }
    function maybeSaveBest(time, mistakes, diff){
      let all={}; try{ all=JSON.parse(localStorage.getItem(LS.BEST)||"{}"); }catch{}
      const cur=all[diff];
      if(!cur || time<cur.time || (time===cur.time && mistakes<cur.mist)){
        all[diff]={time, mist:mistakes}; localStorage.setItem(LS.BEST, JSON.stringify(all)); setCookie(LS.BEST, JSON.stringify(all));
      }
    }
    function updateHomeStats(){
      const b=loadBestFor(els.difficulty.value);
      $("#bestTime").textContent=b?fmtTime(b.time):"‚Äì";
      $("#bestMist").textContent=b?(b.mist+"‚ùå"):"‚Äì";
      try{
        const last=JSON.parse(localStorage.getItem(LS.LAST)||"null");
        $("#lastTime").textContent=last?fmtTime(last.time):"‚Äì";
        $("#lastMist").textContent=last?(last.mistakes+"‚ùå"):"‚Äì";
        $("#lastDate").textContent=last?new Date(last.at).toLocaleString():"‚Äì";
      }catch{ $("#lastTime").textContent=$("#lastMist").textContent=$("#lastDate").textContent="‚Äì"; }
    }

    /* ---------- Inputs ---------- */
    $(".keypad").addEventListener("click", (e)=>{ const k=e.target?.dataset?.k; if(!k) return; placeNumber(Number(k)); });
    document.addEventListener("keydown", (e)=>{
      if(els.play.hasAttribute("inert")) return;
      if(e.key>="1" && e.key<="9"){ placeNumber(Number(e.key)); e.preventDefault(); }
      if(e.key==="Backspace" || e.key==="Delete"){ placeNumber(0); e.preventDefault(); }
      if(e.key==="ArrowUp"){ moveSel(-1,0); e.preventDefault(); }
      if(e.key==="ArrowDown"){ moveSel(1,0); e.preventDefault(); }
      if(e.key==="ArrowLeft"){ moveSel(0,-1); e.preventDefault(); }
      if(e.key==="ArrowRight"){ moveSel(0,1); e.preventDefault(); }
      if(e.key==="n" || e.key==="N"){ toggleNotes(); }
      if(e.key==="p" || e.key==="P"){ if(S.paused) hideOverlay(); else showOverlay("Paused","Tap anywhere or press P"); }
    }, {passive:false});
    function moveSel(dr,dc){ let {r,c}=S.selected; if(r<0||c<0){ r=0; c=0; } r=clamp(r+dr,0,8); c=clamp(c+dc,0,8); selectCell(r,c); }

    function toggleNotes(force){
      S.notesMode = (force===undefined)? !S.notesMode : !!force;
      els.psNotes.classList.toggle("primary", S.notesMode);
      els.psNotes.setAttribute("aria-pressed", S.notesMode? "true":"false");
    }

    /* ---------- Buttons ---------- */
    $("#newGame").addEventListener("click", ()=>{ openPlay("", els.difficulty.value); S.mistLimit=Number(els.mistLimit.value); updateErrorsLeft(); });
    $("#continueBtn").addEventListener("click", ()=>{
      const saved=loadLocal();
      if(!saved){ $("#continueBtn").disabled=true; $("#continueBtn").style.opacity=.7; return; }
      setInert(els.home,true); setInert(els.play,false); els.play.classList.add("open");
      Object.assign(S,{ difficulty:saved.difficulty||"normal", mistLimit:Number(saved.mistLimit||5), seed:saved.seed||"",
        puzzle:saved.puzzle, solution:saved.solution, given:saved.given,
        mistakes:saved.mistakes||0, elapsed:saved.elapsed||0,
        notes:saved.notes.map(row=>row.map(arr=>new Set(arr))) });
      buildGrid(); updateHUD(); updateErrorsLeft(); S.paused=false; startTimer(); $("#psBack").focus({preventScroll:true});
    });
    $("#resetBest").addEventListener("click", ()=>{ localStorage.removeItem(LS.BEST); setCookie(LS.BEST,"{}"); updateHomeStats(); });
    $("#shareBtn").addEventListener("click", ()=>{
      const seed=Date.now().toString(36);
      const u=new URL(location.href); u.searchParams.set("seed",seed); u.searchParams.set("d", els.difficulty.value);
      navigator.clipboard?.writeText(u.toString()); $("#homeStatus").textContent="üîó Link copied. Challenge a friend!";
    });

    $("#psBack").addEventListener("click", closePlay);
    $("#psRestart").addEventListener("click", ()=>{
      generate(S.seed, S.difficulty); buildGrid();
      S.elapsed=0; S.mistakes=0; S.paused=false; startTimer(); updateHUD(); updateErrorsLeft(); hideOverlay();
    });
    $("#psShare").addEventListener("click", ()=>{
      const seed=S.seed||Date.now().toString(36); S.seed=seed;
      const u=new URL(location.href); u.searchParams.set("seed",seed); u.searchParams.set("d",S.difficulty);
      navigator.clipboard?.writeText(u.toString()); showOverlay("Link copied","Share this puzzle with friends!");
    });
    $("#psNotes").addEventListener("click", ()=>toggleNotes());
    $("#ovResume").addEventListener("click", ()=>hideOverlay());
    $("#ovRestart").addEventListener("click", ()=>{
      hideOverlay(); generate(S.seed,S.difficulty); buildGrid();
      S.elapsed=0; S.mistakes=0; S.paused=false; startTimer(); updateHUD(); updateErrorsLeft();
    });
    window.addEventListener("blur", ()=>{ if(!els.play.hasAttribute("inert")) showOverlay("Paused","Window unfocused"); });

    (function initHome(){
      updateHomeStats();
      const saved=loadLocal(); if(!saved){ $("#continueBtn").disabled=true; $("#continueBtn").style.opacity=.7; }
      const u=new URL(location.href);
      const qSeed=u.searchParams.get("seed"), qDiff=u.searchParams.get("d");
      if(qSeed){ openPlay(qSeed, qDiff||els.difficulty.value); u.searchParams.delete("seed"); u.searchParams.delete("d"); history.replaceState(null,"",u.toString()); }
    })();
  </script>
</body>
</html>
