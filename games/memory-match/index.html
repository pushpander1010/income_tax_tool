<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Single async ad (kept minimal for performance) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6216304334889617" crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Memory Match - Free Online Game (Easy/Medium/Hard, Peek, Best Time) | UpTools</title>

  <!-- SEO -->
  <meta name="description" content="Play Memory Match online (mobile + desktop). Choose Easy, Medium, or Hard, then tap New Game: a clean full-screen window opens with timer and a back button. Peek start, keyboard support, sounds & haptics, per-level best time & moves, and a grid that always fits your screen. Stop anytime with Back to return to the home screen." />
  <link rel="canonical" href="https://www.uptools.in/games/memory-match" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:large" />
  <meta name="theme-color" content="#0f1419" />

  <!-- OG/Twitter -->
  <meta property="og:title" content="Memory Match - Free Online Game | UpTools" />
  <meta property="og:description" content="Tap New Game to open a dedicated full-screen play window with timer + back button. Peek start, best times, sounds, haptics." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.uptools.in/games/memory-match" />
  <meta property="og:site_name" content="UpTools" />
  <meta property="og:image" content="/assets/og/memory-match.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Icons -->
  <link rel="icon" sizes="50x50" type="image/svg+xml" href="/assets/logo/uptools-logo.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/uptools-logo.svg">

  <!-- Performance hints -->
  <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
  <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">

  <!-- Common CSS -->
  <link rel="preload" href="/style.css?v=1.2.7" as="style">
  <link rel="stylesheet" href="/style.css?v=1.2.7" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="/style.css?v=1.2.7"></noscript>

  <!-- Tiny page styles (CLS-safe) -->
  <style>
    :root{
      --accent:#4ecdc4; --accent2:#5fe1d8; --danger:#ff6b6b;
      --bg:#0f1419; --bg1:#0f1419; --bg2:#121a26; --card:#1e2634; --cardBorder:#2a3b55; --muted:#9aa4b2;
    }
    body{ background: radial-gradient(1200px 600px at 10% -10%, #162130 0%, var(--bg) 45%) fixed; min-height:100svh; }
    body.lock-scroll{ overflow:hidden; }

    /* Landing (home) */
    .tool-header{ text-align:center; margin:1rem 0 .25rem }
    .tool-header h1{ display:flex; align-items:center; justify-content:center; gap:.5rem }
    .tool-header p{ margin:.25rem 0 0 }

    .game-wrap{ max-width:1100px; margin:0 auto; padding:1rem; }
    .panel{
      background:var(--card); border:1px solid var(--cardBorder);
      border-radius:.75rem; box-shadow:0 6px 30px rgba(0,0,0,.25);
      padding:1rem; margin:0 auto; overflow:hidden;
    }
    .hud{ display:grid; grid-template-columns:repeat(5,1fr); gap:.75rem; align-items:center; margin-bottom:.75rem; }
    .kpi{ text-align:center; padding:.5rem .75rem; border:1px solid var(--cardBorder); border-radius:.75rem; background:rgba(255,255,255,.02) }
    .kpi .value{ font-size:1.15rem; font-weight:800; color:var(--accent) }
    .kpi .label{ font-size:.75rem; color:var(--muted) }

    .bar{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; justify-content:center; margin:.5rem 0 0; }
    .difficulty-btn{
      padding:.55rem .9rem; border-radius:.6rem; border:1px solid var(--cardBorder);
      background:#0f151f; color:#e6edf3; font-weight:700; cursor:pointer;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .difficulty-btn:hover{ border-color:var(--accent) }
    .difficulty-btn.active{ background:var(--accent); color:#0b1020; border-color:var(--accent) }

    .controls{ display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin:.75rem 0 0 }
    .btn{ padding:.66rem 1.05rem; border:none; border-radius:.75rem; font-weight:800; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease; }
    .btn.primary{ background:var(--accent); color:#0b1020 }
    .btn.secondary{ background:transparent; color:#e6edf3; border:1px solid var(--cardBorder) }
    .btn.danger{ background:var(--danger); color:#0b1020 }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 26px rgba(0,0,0,.25) }

    .status{ text-align:center; margin:.75rem 0 0; color:var(--muted); font-weight:600 }

    @media (max-width:640px){
      .hud{ grid-template-columns:repeat(2,1fr); }
      .panel{ padding:.75rem; }
    }

    /* ========= FULL-SCREEN PLAY WINDOW ========= */
    #playScreen{
      position:fixed; inset:0; display:none; z-index:50;
      background:linear-gradient(180deg, rgba(7,12,20,.95), rgba(9,14,22,.98));
      padding: max(8px, env(safe-area-inset-top)) clamp(8px, 2vw, 18px) max(10px, env(safe-area-inset-bottom));
    }
    #playScreen.open{ display:grid; grid-template-rows:auto 1fr auto; gap:.6rem; }
    .ps-top{
      display:flex; align-items:center; justify-content:space-between; gap:.5rem;
      background:rgba(255,255,255,.03); border:1px solid var(--cardBorder); border-radius:.65rem; padding:.5rem .6rem;
    }
    .ps-top .left, .ps-top .right{ display:flex; align-items:center; gap:.5rem }
    .ps-title{ font-weight:900 }
    .ps-timer{ font-weight:900; font-variant-numeric:tabular-nums; padding:.25rem .5rem; border-radius:.45rem; background:#0f151f; border:1px solid var(--cardBorder) }
    .ps-btn{ padding:.5rem .8rem; border-radius:.6rem; border:1px solid var(--cardBorder); background:#0f151f; color:#e6edf3; font-weight:800; cursor:pointer }
    .ps-btn.primary{ background:var(--accent); color:#0b1020; border-color:var(--accent) }

    .ps-stage{
      min-height:0; display:grid; align-items:center; justify-items:center;
    }
    .board{
      background:var(--card); border:1px solid var(--cardBorder); border-radius:.75rem;
      padding:.75rem; width:min(1100px,100%); height:100%;
      display:grid; align-content:center; justify-items:center; overflow:hidden;
    }

    .ps-bottom{ display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center }
    .note{ color:var(--muted); font-size:.85rem; text-align:center; margin-top:.35rem }

    /* Grid/tiles inside play window */
    .grid{
      --gap: clamp(6px, 2.2vw, 14px);
      display:grid; gap: var(--gap);
      margin:0 auto; justify-content:center; width:100%; max-width:100%;
    }
    .grid.easy, .grid.medium, .grid.hard{
      grid-template-columns: repeat(var(--cols,4), var(--tile,72px));
      grid-auto-rows: var(--tile,72px);
    }

    .card-tile{
      aspect-ratio:1; position:relative; border-radius:12px;
      border:2px solid var(--cardBorder); background:#0f151f;
      display:grid; place-items:center; cursor:pointer; user-select:none;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
      outline:none; min-width:24px; min-height:24px;
      touch-action: manipulation; /* snappier taps */
    }
    .card-tile:hover{ transform:translateY(-1px); border-color:var(--accent) }
    .card-tile:focus-visible{ box-shadow:0 0 0 3px color-mix(in hsl, var(--accent) 35%, transparent); border-color:var(--accent) }
    .face{ font-size:clamp(16px, calc(var(--tile,72px) * .42), 40px); transform:scale(.85); opacity:0; transition:opacity .12s ease, transform .12s ease; }
    .flipped .face{ opacity:1; transform:scale(1) }
    .flipped{ background:linear-gradient(135deg, #0f151f, #203040); border-color:var(--accent) }
    .matched{ background:var(--accent); border-color:var(--accent); color:#0b1020; animation:pulse .35s ease-in-out }
    @keyframes pulse{ 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.05)} }
    .peek .card-tile .face{ opacity:1; transform:scale(1) }
    .peek .card-tile{ border-color:rgba(255,255,255,.15) }
  </style>

  <!-- Structured data -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebApplication","name":"Memory Match","url":"https://www.uptools.in/games/memory-match","applicationCategory":"Game","operatingSystem":"Any","publisher":{"@type":"Organization","name":"UpTools"},"offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}
  </script>
</head>
<body>
  <!-- Header -->
  <header class="site" role="banner">
    <div class="header-inner">
      <a class="brand" href="/" aria-label="UpTools Home">
        <img src="/assets/logo/uptools-logo.svg" alt="UpTools logo" width="28" height="28" loading="eager">
        <b>UpTools</b>
      </a>
      <nav class="nav-links" aria-label="Primary">
        <a href="/#tools">Tools</a>
        <a aria-current="page" href="/games/">Games</a>
        <a href="/about/">About</a>
        <a href="/contact/">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Home/Landing screen -->
  <main class="wrap" id="homeScreen">
    <div class="tool-header">
      <h1>🧠 Memory Match</h1>
      <p>Pick a difficulty and press <b>New Game</b>. A dedicated full-screen window opens with a timer and a back button.</p>
    </div>

    <div class="game-wrap">
      <section class="panel">
        <div class="hud" aria-live="polite">
          <div class="kpi"><div class="value" id="bestEasy">--:--</div><div class="label">Best Easy</div></div>
          <div class="kpi"><div class="value" id="bestMed">--:--</div><div class="label">Best Medium</div></div>
          <div class="kpi"><div class="value" id="bestHard">--:--</div><div class="label">Best Hard</div></div>
          <div class="kpi"><div class="value" id="bestMoves">--</div><div class="label">Best Moves (Current)</div></div>
          <div class="kpi"><div class="value" id="streak">0</div><div class="label">Daily Streak</div></div>
        </div>

        <div class="bar" role="toolbar" aria-label="Difficulty">
          <button class="difficulty-btn active" data-level="easy">Easy (8)</button>
          <button class="difficulty-btn" data-level="medium">Medium (18)</button>
          <button class="difficulty-btn" data-level="hard">Hard (32)</button>
        </div>

        <div class="controls" role="toolbar" aria-label="Controls">
          <button id="newGame" class="btn primary">New Game</button>
          <button id="toggleSound" class="btn secondary" aria-pressed="true">🔊 Sound On</button>
          <button id="toggleHaptics" class="btn secondary" aria-pressed="true">📳 Haptics On</button>
          <button id="toggleCB" class="btn secondary" aria-pressed="false">🅰️ CB Assist</button>
          <button id="resetBest" class="btn danger">Reset Bests</button>
          <button id="shareBtn" class="btn secondary">🔗 Challenge Link</button>
        </div>

        <p class="status" id="homeStatus">Peek start is enabled. Best times are stored on your device.</p>
      </section>
    </div>

    <footer class="site-foot small" style="text-align:center; margin:1rem 0 2rem">
      <nav class="nav-links small">
        <a href="/">UpTools</a> · <a href="/sitemap.xml">Sitemap</a> · <a href="/games/">Games</a> · <a href="/about/">About</a> · <a href="/contact/">Contact</a>
      </nav>
      <div class="note">Privacy-first · Works offline once loaded</div>
      <nav class="nav-links small" style="margin-top:.25rem">
        Related: <a href="/games/color-rush/">Color Rush</a> · <a href="/games/snake/">Snake</a>
      </nav>
    </footer>
  </main>

  <!-- FULL-SCREEN play window (opens on New Game) -->
  <!-- NOTE: default state is inert (not focusable / not exposed); we toggle this in JS. -->
  <section id="playScreen" role="dialog" aria-modal="true" inert>
    <div class="ps-top">
      <div class="left">
        <button id="psBack" class="ps-btn" type="button" aria-label="Stop and go back">⟵ Back</button>
        <span class="ps-title">Memory Match</span>
      </div>
      <div class="mid">
        <span class="ps-timer" id="psTimer">00:00</span>
      </div>
      <div class="right" aria-label="Quick actions">
        <button id="psPause" class="ps-btn" aria-pressed="false">⏸️ Pause</button>
        <button id="psHint" class="ps-btn" title="Show all briefly (+5s)">💡 Hint</button>
      </div>
    </div>

    <div class="ps-stage">
      <div class="board">
        <!-- dynamic grid lives here while playing -->
        <div id="grid" class="grid easy" role="grid" aria-label="Memory cards"></div>
      </div>
    </div>

    <div class="ps-bottom">
      <button id="psNew" class="ps-btn primary">New Game</button>
      <button id="psShare" class="ps-btn">🔗 Share this board</button>
    </div>
    <div class="note">Use <kbd>Space</kbd>/<kbd>Enter</kbd> to flip, <kbd>Esc</kbd> or <b>Back</b> to stop.</div>
  </section>

  <!-- App script (ESM, imports from /scripts/utils.js) -->
  <script type="module">
    import * as U from "/scripts/utils.js";
    const $  = U.$  ?? ((s, el=document) => el.querySelector(s));
    const $$ = U.$$ ?? ((s, el=document) => [...el.querySelectorAll(s)]);
    const clamp = U.clamp ?? ((x,min,max)=>Math.min(max,Math.max(min,x)));

    // Game-local helpers
    const randInt = (n) => (Math.random() * n) | 0;
    const pad2 = (n)=>String(n).padStart(2,"0");

    // Prevent arrow keys/space from scrolling page
    addEventListener("keydown", (e) => {
      if (["ArrowUp","ArrowDown"," "].includes(e.key)) e.preventDefault();
    }, {passive:false});

    // Toggles persisted
    let soundOn   = JSON.parse(localStorage.getItem("mem-sound")   ?? "true");
    let hapticsOn = JSON.parse(localStorage.getItem("mem-haptics") ?? "true");
    let cbAssist  = JSON.parse(localStorage.getItem("mem-cb")      ?? "false");
    const setToggle = (btn, on, onTxt, offTxt) => { btn?.setAttribute("aria-pressed", String(on)); if(btn) btn.textContent = on?onTxt:offTxt; };

    setToggle($("#toggleSound"), soundOn, "🔊 Sound On", "🔇 Sound Off");
    setToggle($("#toggleHaptics"), hapticsOn, "📳 Haptics On", "📴 Haptics Off");
    setToggle($("#toggleCB"), cbAssist, "🅰️ CB Assist", "🅰️ CB Assist Off");
    document.body.classList.toggle("cb", cbAssist);

    $("#toggleSound")?.addEventListener("click", ()=>{ soundOn=!soundOn; localStorage.setItem("mem-sound", JSON.stringify(soundOn)); setToggle($("#toggleSound"), soundOn, "🔊 Sound On", "🔇 Sound Off"); });
    $("#toggleHaptics")?.addEventListener("click", ()=>{ hapticsOn=!hapticsOn; localStorage.setItem("mem-haptics", JSON.stringify(hapticsOn)); setToggle($("#toggleHaptics"), hapticsOn, "📳 Haptics On", "📴 Haptics Off"); });
    $("#toggleCB")?.addEventListener("click", ()=>{ cbAssist=!cbAssist; localStorage.setItem("mem-cb", JSON.stringify(cbAssist)); setToggle($("#toggleCB"), cbAssist, "🅰️ CB Assist", "🅰️ CB Assist Off"); document.body.classList.toggle("cb", cbAssist); });

    // WebAudio bleeps
    let audioCtx = null;
    const beep = (type="square", freq=440, ms=80, gain=0.025) => {
      if (!soundOn) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq; g.gain.value = gain;
        o.connect(g); g.connect(audioCtx.destination); o.start();
        setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, ms);
      }catch{}
    };
    const buzz = (ms=15) => { if (hapticsOn && navigator.vibrate) navigator.vibrate(ms); };

    // Seed helpers for shareable boards
    const mulberry32 = (seed) => { let t=seed>>>0; return ()=>{ t+=0x6D2B79F5; let r=Math.imul(t^t>>>15,1|t); r^=r+Math.imul(r^r>>>7,61|r); return ((r^r>>>14)>>>0)/4294967296; }; };
    const strHash = (s) => { let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; };

    // ===== Game Class (rendered only inside #playScreen) =====
    class MemoryMatch {
      constructor(level, seed=""){
        this.level = level;
        this.seed = seed;
        this.pool = ["🍎","🍊","🍋","🍉","🍇","🍓","🍒","🍍","🥝","🥑","🥕","🌶️","🍄","🥨","🍪","🍰","🐶","🐱","🐭","🐹","🐰","🦊","🐻","🐼","🦁","🐯","🦄","🐸","🐵","🐙","🐠","🦋"];
        this.cfg = { easy:{pairs:4,cols:4,minTile:64}, medium:{pairs:9,cols:6,minTile:42}, hard:{pairs:16,cols:8,minTile:26} };

        // State
        this.cards=[]; this.flipped=[]; this.pairsFound=0; this.moves=0;
        this.running=false; this.paused=false; this.seconds=0; this.penalty=0; this._tick=null;

        // Mobile-friendly interaction control
        this.lock = false;      // lock only during mismatch flip-back
        this._queued = null;    // queue a tap during lock

        // DOM in play window
        this.grid = $("#grid");
        this.timerEl = $("#psTimer");

        // Build & show
        this.setup();
      }

      setup(){
        this.grid.className = "grid " + this.level;

        const deck = this.buildDeck();
        this.mount(deck);

        // Peek
        document.body.classList.add("peek");
        this.cards.forEach(c=>c.el.classList.add("flipped"));
        setTimeout(()=>{
          document.body.classList.remove("peek");
          this.cards.forEach(c=>c.el.classList.remove("flipped"));
          statusHome("Go! Flip any card to start the timer.");
        }, 1200);

        requestAnimationFrame(()=>this.layout());
        addEventListener("resize", this._onResize = ()=>this.layout(), {passive:true});
        addEventListener("orientationchange", this._onResize);
      }

      destroy(){
        clearInterval(this._tick); this._tick=null;
        removeEventListener("resize", this._onResize);
        removeEventListener("orientationchange", this._onResize);
        this.grid.innerHTML="";
        this.running=false; this.paused=false; this.lock=false; this._queued=null;
      }

      buildDeck(){
        const {pairs} = this.cfg[this.level];
        let symbols = [...this.pool];
        if (this.seed){
          const rng = mulberry32(strHash(this.seed));
          for(let i=symbols.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [symbols[i],symbols[j]]=[symbols[j],symbols[i]]; }
        }
        symbols = symbols.slice(0,pairs);
        const deck = []; let id=0;
        for(const s of symbols){ deck.push({id:id++,symbol:s}); deck.push({id:id++,symbol:s}); }
        const rng = this.seed ? mulberry32(strHash(this.seed+"shuf")) : null;
        for(let i=deck.length-1;i>0;i--){
          const j = rng ? Math.floor(rng()*(i+1)) : randInt(i+1);
          [deck[i],deck[j]]=[deck[j],deck[i]];
        }
        return deck;
      }

      mount(deck){
        this.grid.innerHTML="";
        this.cards = deck.map(card=>{
          const el = document.createElement("button");
          el.className="card-tile"; el.type="button"; el.role="gridcell";
          el.dataset.symbol = card.symbol;
          // No letters (anti-cheat)
          el.innerHTML = `<span class="face" aria-hidden="true">${card.symbol}</span>`;
          el.addEventListener("click",()=>this.flip(el));
          el.addEventListener("keydown",(e)=>{ if(e.key===" "||e.key==="Enter"){ e.preventDefault(); this.flip(el);} });
          this.grid.appendChild(el);
          return { ...card, el, matched:false };
        });
        this.grid.querySelector(".card-tile")?.focus({preventScroll:true});
      }

      start(){
        if(this.running) return;
        this.running=true;
        this._tick = setInterval(()=>{ if(!this.paused){ this.seconds++; this.renderTimer(); }},1000);
      }

      pauseToggle(on){
        this.paused = on ?? !this.paused;
        $("#psPause").setAttribute("aria-pressed", String(this.paused));
        $("#psPause").textContent = this.paused ? "▶️ Resume" : "⏸️ Pause";
      }

      stop(){
        clearInterval(this._tick); this._tick=null; this.running=false; this.paused=false;
      }

      flip(el){
        // ignore invalid targets
        if (!el || el.classList.contains("matched") || el.classList.contains("flipped")) return;

        // if a mismatch is animating, queue one tap (mobile UX)
        if (this.lock){
          this._queued = el; // keep last intent
          return;
        }
        if(this.paused) return;

        if(!this.running) this.start();

        el.classList.add("flipped"); beep("triangle", 560, 50, .02);
        this.flipped = this.flipped || [];
        this.flipped.push(el);

        if(this.flipped.length===2){
          this.checkMatch();
        }
      }

      checkMatch(){
        const [a,b] = this.flipped;
        this.moves++;
        const same = a.dataset.symbol === b.dataset.symbol;

        if(same){
          a.classList.add("matched"); b.classList.add("matched");
          this.pairsFound++; this.flipped=[];
          beep("sine",760,90,.03); buzz(12);
          if(this.isDone()) this.finish();
          // No lock on match → allow immediate third flip
        }else{
          // lock only during flip-back; make it snappy on phones
          this.lock = true;
          beep("sawtooth",220,90,.025);
          setTimeout(()=>{
            a.classList.remove("flipped");
            b.classList.remove("flipped");
            this.flipped=[];
            this.lock = false;

            // if the player tapped a third card while locked, flip it now
            if (this._queued && !this._queued.classList.contains("matched") && !this._queued.classList.contains("flipped")){
              const next = this._queued; this._queued = null;
              this.flip(next);
            } else {
              this._queued = null;
            }
          }, 420); // shorter than before (650ms)
        }
      }

      isDone(){ return this.pairsFound === this.cfg[this.level].pairs; }

      finish(){
        this.stop();
        const total = this.seconds + this.penalty;
        const kT=`mem-best-${this.level}-time`, kM=`mem-best-${this.level}-moves`;
        const curT=+(localStorage.getItem(kT)||0), curM=+(localStorage.getItem(kM)||0);
        if(curT===0 || total<curT) localStorage.setItem(kT,String(total));
        if(curM===0 || this.moves<curM) localStorage.setItem(kM,String(this.moves));
        renderHomeBests();
        statusHome(`🎉 ${this.formatTime(total)} · ${this.moves} moves`);
      }

      hint(){
        if(!this.running) this.start();
        this.penalty += 5;
        document.body.classList.add("peek");
        this.cards.forEach(c=>c.el.classList.add("flipped"));
        setTimeout(()=>{
          document.body.classList.remove("peek");
          this.cards.filter(c=>!c.el.classList.contains("matched")).forEach(c=>c.el.classList.remove("flipped"));
        }, 1000);
      }

      share(){
        if(!this.seed){ this.seed = Date.now().toString(36); }
        const url = new URL(location.href);
        url.searchParams.set("level", this.level);
        url.searchParams.set("seed", this.seed);
        navigator.clipboard?.writeText(url.toString());
        statusHome("🔗 Link copied. Challenge a friend!");
      }

      formatTime(s){ return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`; }
      renderTimer(){ this.timerEl.textContent = this.formatTime(this.seconds + this.penalty); }

      layout(){
        const cfg=this.cfg[this.level], cols=cfg.cols, rows=Math.ceil((cfg.pairs*2)/cols);
        this.grid.style.setProperty('--cols', cols);

        const board = this.grid.closest(".board");
        const bcs = getComputedStyle(board);
        const padX = parseFloat(bcs.paddingLeft)+parseFloat(bcs.paddingRight);
        const padY = parseFloat(bcs.paddingTop)+parseFloat(bcs.paddingBottom);
        const availW = Math.max(160, board.clientWidth - padX);
        const availH = Math.max(180, board.clientHeight - padY);

        const gap = parseFloat(getComputedStyle(this.grid).gap) || 10;
        const tileW = Math.floor((availW - (cols-1)*gap)/cols);
        const tileH = Math.floor((availH - (rows-1)*gap)/rows);
        const tile = Math.max(cfg.minTile, Math.min(tileW, tileH));

        this.grid.style.setProperty('--tile', tile + 'px');
        const boardW = cols*tile + (cols-1)*gap;
        this.grid.style.width = Math.min(boardW, availW) + "px";
      }
    }

    // ===== Landing screen interactions =====
    let currentLevel = localStorage.getItem("mem-level") || "easy";
    const applyLevelButtons = ()=>{
      $$(".difficulty-btn").forEach(b=>b.classList.toggle("active", b.dataset.level===currentLevel));
    };
    applyLevelButtons();
    $$(".difficulty-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{ currentLevel = btn.dataset.level; localStorage.setItem("mem-level", currentLevel); applyLevelButtons(); });
    });

    $("#shareBtn").addEventListener("click", ()=>{
      const url = new URL(location.href);
      url.searchParams.set("level", currentLevel);
      navigator.clipboard?.writeText(url.toString());
      statusHome("🔗 Link copied. Share your preferred level.");
    });

    $("#resetBest").addEventListener("click", ()=>{
      ["easy","medium","hard"].forEach(l=>{
        localStorage.removeItem(`mem-best-${l}-time`);
        localStorage.removeItem(`mem-best-${l}-moves`);
      });
      renderHomeBests();
      statusHome("Best stats reset.");
    });

    const timeStr = (s)=>`${pad2(Math.floor(s/60))}:${pad2(s%60)}`;
    function renderHomeBests(){
      const tE = localStorage.getItem("mem-best-easy-time");
      const tM = localStorage.getItem("mem-best-medium-time");
      const tH = localStorage.getItem("mem-best-hard-time");
      $("#bestEasy").textContent = tE ? timeStr(+tE) : "--:--";
      $("#bestMed").textContent  = tM ? timeStr(+tM) : "--:--";
      $("#bestHard").textContent = tH ? timeStr(+tH) : "--:--";
      const bm = localStorage.getItem(`mem-best-${currentLevel}-moves`);
      $("#bestMoves").textContent = bm || "--";
      const streak = +(localStorage.getItem("mem-daily-streak") || 0);
      $("#streak").textContent = String(streak);
    }
    function statusHome(msg){ $("#homeStatus").textContent = msg; }
    renderHomeBests();

    // ===== Full-screen window control (uses inert instead of aria-hidden) =====
    let game = null;
    let escHandler = null;
    const playScreen = $("#playScreen");
    const homeScreen = $("#homeScreen");

    function setInert(el, val){
      if (val){ el.setAttribute("inert",""); el.inert = true; }
      else { el.removeAttribute("inert"); el.inert = false; }
    }

    function openPlayWindow(seedFromURL = (new URL(location.href)).searchParams.get("seed") || ""){
      // Activate play screen; deactivate home
      setInert(homeScreen, true);
      setInert(playScreen, false);
      playScreen.classList.add("open");
      document.body.classList.add("lock-scroll");

      // Create game instance
      game = new MemoryMatch(currentLevel, seedFromURL);

      // Reflect CB assist toggle (no letters rendered, but kept for future)
      document.body.classList.toggle("cb", JSON.parse(localStorage.getItem("mem-cb") ?? "false"));

      // Wire quick controls
      $("#psPause").onclick = ()=> game.pauseToggle();
      $("#psHint").onclick = ()=> game.hint();
      $("#psNew").onclick  = ()=> { game.destroy(); game = new MemoryMatch(currentLevel, ""); };
      $("#psShare").onclick= ()=> game.share();

      // Focus
      $("#psBack").focus({preventScroll:true});

      // Keyboard Esc leaves
      escHandler = (e)=>{ if(e.key==="Escape"){ closePlayWindow(true); } };
      addEventListener("keydown", escHandler);
    }

    function closePlayWindow(stopGame){
      // Move focus back to home before making playScreen inert
      $("#newGame").focus({preventScroll:true});

      playScreen.classList.remove("open");
      document.body.classList.remove("lock-scroll");

      if (stopGame && game){ game.stop(); }
      if (game){ game.destroy(); game=null; }

      removeEventListener("keydown", escHandler); escHandler=null;

      // Deactivate play, reactivate home
      setInert(playScreen, true);
      setInert(homeScreen, false);

      renderHomeBests();
    }

    $("#newGame").addEventListener("click", ()=> openPlayWindow());
    $("#psBack").addEventListener("click", ()=> closePlayWindow(true));

    // Support challenge links (?level=&seed=) to auto-open play
    const url = new URL(location.href);
    const qLevel = url.searchParams.get("level");
    if (qLevel && ["easy","medium","hard"].includes(qLevel)){
      currentLevel = qLevel; applyLevelButtons();
      openPlayWindow(url.searchParams.get("seed") || "");
      // Clean URL (no reload) after opening
      url.searchParams.delete("level"); url.searchParams.delete("seed");
      history.replaceState(null,"",url.toString());
    }
  </script>
</body>
</html>
